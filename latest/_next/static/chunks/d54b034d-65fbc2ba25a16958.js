"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[6697],{89084:function(e,t,r){r.d(t,{oe:function(){return Ye},J5:function(){return In},lH:function(){return yt}});var n=r(95311),i=r(81162),o=r(99488),s=r.n(o),a=r(78094),l=r.n(a),c=r(75944),h=r(27843),d=r.n(h),u=r(10643),p=r(89444),v=r(22876),g=r.n(v),f=r(65089),y=r.n(f),w=r(68230);const m=e=>({name:"Value",value:e}),b=e=>({name:"Expression",value:e}),k=e=>({name:"PathNode",path:e}),S=(e,t)=>({name:"Query",key:e,value:t}),E=e=>1===e.length?e[0]:{name:"Concatenated",value:e},O=l().string('"'),P=l().string("'"),j=l().string("`"),A=l().regex(/[\w\-@]+/).desc("identifier").map(m);let T;const V=l().lazy((()=>T)).trim(l().optWhitespace).wrap(l().string("{{"),l().string("}}")).map(k),x=l().regex(/[^`]*/).wrap(j,j).map(b),C=l().alt(A,V,x).atLeast(1).map(s()).map(E),N=l().alt(l().regex(/[^"]*/).wrap(O,O).map(m),l().regex(/[^']*/).wrap(P,P).map(m),C),_=l().seq(N,l().string("=").times(1,3).trim(l().optWhitespace),N).map((([e,,t])=>S(e,t))),B=l().alt(_,N).trim(l().optWhitespace).wrap(l().string("["),l().string("]")).many(),M=l().seqMap(C,B,((e,t)=>[e,...t]));T=l().sepBy(M,l().string(".")).map(s()),new c.Grammars.W3C.Parser('\nvalue                      ::= segment_and_bracket (SEGMENT_SEPARATOR segment_and_bracket)*\nsegment                    ::= concatenated | expression | modelRef | identifier  \nconcatenated               ::= (expression | modelRef | identifier)+ \nmodelRef                   ::= OPEN_CURL OPEN_CURL value CLOSE_CURL CLOSE_CURL \nidentifier                 ::= [\\w\\-@]+\nquery                      ::= WHITESPACE* optionally_quoted_segment WHITESPACE* EQUALS EQUALS? EQUALS? WHITESPACE* optionally_quoted_segment WHITESPACE*\nbrackets                   ::= OPEN_BRACKET WHITESPACE* (query | optionally_quoted_segment) WHITESPACE* CLOSE_BRACKET \nsegment_and_bracket        ::= segment brackets*\nquoted_value               ::= [^"\']*\noptionally_quoted_segment  ::= WHITESPACE* SINGLE_QUOTE quoted_value SINGLE_QUOTE WHITESPACE* | WHITESPACE* DOUBLE_QUOTE quoted_value DOUBLE_QUOTE WHITESPACE* | WHITESPACE* segment WHITESPACE*\nexpression_value           ::= [^`]*\nexpression                 ::= BACK_TICK expression_value BACK_TICK\n\nEQUALS                     ::= "="\nSEGMENT_SEPARATOR          ::= "."\nSINGLE_QUOTE               ::= "\'"\nDOUBLE_QUOTE               ::= \'"\'\nWHITESPACE                 ::= " "\nOPEN_CURL                  ::= "{"\nCLOSE_CURL                 ::= "}" \nOPEN_BRACKET               ::= "[" \nCLOSE_BRACKET              ::= "]"\nBACK_TICK                  ::= "`" \n');const R="{",D="'",I="`",U=e=>{if(!e)return!1;const t=e.charCodeAt(0);return!(32===t||34===t||39===t||40===t||41===t||42===t||46===t||61===t||91===t||93===t||96===t||123===t||125===t)},$=e=>{let t=1,r=e.charAt(0);const n=n=>{if(n&&r!==n)throw new Error(`Expected char: ${n} but got: ${r}`);return r=e.charAt(t),t+=1,r},i=()=>{for(;" "===r;)n()},o=()=>{var e,t;return null!=(t=null!=(e=(()=>{if(r===R&&(n(R),r===R)){n(R);const e=c();return n("}"),n("}"),e}})())?e:(()=>{if(r===I){n(I);let e=r;for(;n()&&r!==I;)e+=r;if(n(I),e)return b(e)}})())?t:(()=>{if(!U(r))return;let e=r;for(;n()&&U(r);)e+=r;return e?m(e):void 0})()},s=()=>{if(i(),r===D||'"'===r){const e=r===D;n(e?D:'"');const t=(e=>{if(!(null==r?void 0:r.match(e)))return;let t=r;for(;n()&&(null==r?void 0:r.match(e));)t+=r;return t?m(t):void 0})(/[^'"]+/);return n(e?D:'"'),t}return o()},a=()=>{if("["===r){n("["),i();let e=s();if(!e)throw new Error("Expected identifier");if(i(),(()=>{if("="!==r)return!1;for(;"="===r;)n();return!0})()){i();const t=s();e=S(e,t),i()}return e&&n("]"),e}},l=()=>{const e=[],t=(()=>{const e=[];let t=o();for(;void 0!==t;)e.push(t),t=o();if(0!==e.length)return E(e)})();if(t){e.push(t);let r=a();for(;void 0!==r;)e.push(r),r=a()}return e},c=()=>{const e=[];let t=l();for(;void 0!==t&&(e.push(...t),r&&"}"!==r);){if(0===t.length&&r)throw new Error(`Unexpected character: ${r}`);n("."),t=l()}return k(e)};try{return{status:!0,path:c()}}catch(h){return{status:!1,error:h.message}}};function F(e){return!("string"===typeof e||Array.isArray(e))}class H{constructor(e,t=(e=>new H(e))){const r=Array.isArray(e)?e:e.split(".");this.split=r.map((e=>{if("number"===typeof e)return e;const t=Number(e);return isNaN(t)?e:t})),Object.freeze(this.split),this.joined=this.split.join("."),this.factory=t}asArray(){return this.split}asString(){return this.joined}contains(e){const t=e.asArray();if(t.length<this.split.length)return!1;for(let r=0;r<this.split.length;r++)if(this.split[r]!==t[r])return!1;return!0}relative(e){return this.asArray().slice(e.asArray().length)}parent(){return this.factory(this.split.slice(0,-1))}key(){return this.split[this.split.length-1]}descendent(e){const t=(r=e,Array.isArray(r)?r:"string"===typeof r?r.split("."):r.asArray());var r;return this.factory(this.split.concat(t))}}var z=Object.defineProperty,L=Object.getOwnPropertySymbols,W=Object.prototype.hasOwnProperty,q=Object.prototype.propertyIsEnumerable,K=(e,t,r)=>t in e?z(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,G=(e,t)=>{for(var r in t||(t={}))W.call(t,r)&&K(e,r,t[r]);if(L)for(var r of L(t))q.call(t,r)&&K(e,r,t[r]);return e};function Q(e,t,r){var n;const o={updates:{},path:[]};function s(e){if("Value"===e.name)return e.value;if("PathNode"===e.name){const n=Q(e,t);n.updates&&(o.updates=G(G({},o.updates),n.updates));try{return t.convertToPath(t.getValue(n.path))}catch(r){throw new i.a6(`Unable to resolve path segment: ${n.path}`,r)}}if("Expression"===e.name)try{const r=t.evaluate(e.value);return t.convertToPath(r)}catch(r){throw new i.a6(`Unable to resolve path: ${e.value}`,r)}throw new Error(`Unable to resolve value for node: ${e.name}`)}function a(e){"string"===typeof e&&e.indexOf(".")>-1?e.split(".").forEach((e=>{o.path.push(function(e){const t=parseInt(e,10);return isNaN(t)?e:t}(e))})):o.path.push(e)}return e.path.forEach((function(e){var n,i;const l=null!=(n=null==r?void 0:r.beforeResolveNode.call(e,G(G({},o),t)))?n:e;switch(l.name){case"Expression":case"PathNode":a(s(l));break;case"Value":a(l.value);break;case"Query":{const e=null!=(i=t.getValue(o.path))?i:[],{key:r,value:n}=l,a=s(r),c=n&&s(n),h=function(e,t,r){return e.findIndex((e=>!(!e||"object"!==typeof e)&&e[t]==r))}(e,a,c);void 0===h||-1===h?(o.updates[[...o.path,e.length,a].join(".")]=c,o.path.push(e.length)):o.path.push(h);break}case"Concatenated":o.path.push(l.value.map(s).join(""));break;default:throw new Error(`Unsupported node type: ${l.name}`)}})),{path:o.path,updates:Object.keys(null!=(n=o.updates)?n:{}).length>0?o.updates:void 0}}var J=Object.defineProperty,Z=Object.getOwnPropertySymbols,X=Object.prototype.hasOwnProperty,Y=Object.prototype.propertyIsEnumerable,ee=(e,t,r)=>t in e?J(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,te=(e,t)=>{for(var r in t||(t={}))X.call(t,r)&&ee(e,r,t[r]);if(Z)for(var r of Z(t))Y.call(t,r)&&ee(e,r,t[r]);return e};const re=/[\s()*=`{}'"[\]]/,ne=/^[^.]+(\..+)*$/,ie={get:()=>{throw new Error("Not Implemented")},set:()=>{throw new Error("Not Implemented")},evaluate:()=>{throw new Error("Not Implemented")}};class oe{constructor(e){this.hooks={skipOptimization:new n.oI,beforeResolveNode:new n.gg},this.parserOptions=te(te({},ie),e),this.cache={},this.parseCache={},this.parse=this.parse.bind(this)}normalizePath(e,t){var r,n;if(!re.test(e)&&ne.test(e)&&!0!==this.hooks.skipOptimization.call(e))return{path:e.split("."),updates:void 0};const o=null!=(r=this.parseCache[e])?r:$(e);if(this.parseCache[e]=o,"object"!==typeof o||!(null==o?void 0:o.status))throw new TypeError(`Cannot normalize path "${e}": ${null!=(n=null==o?void 0:o.error)?n:"Unknown Error."}`);try{return Q(o.path,t,this.hooks)}catch(s){throw new i.a6(`Cannot resolve binding: ${e}`,s)}}getBindingForNormalizedResult(e){const t=e.path.join(".");if(this.cache[t])return this.cache[t];const r=new H(""===t?[]:e.path,this.parse);return this.cache[t]=r,r}parse(e,t={}){if(F(e))return e;const r=te(te({},this.parserOptions),t);let n={};const i=Array.isArray(e)?e.join("."):String(e),o={getValue:e=>{const t=this.normalizePath(e.join("."),o);return r.get(this.getBindingForNormalizedResult(t))},evaluate:e=>r.evaluate(e),convertToPath:e=>{if(void 0===e)throw new Error("Attempted to convert undefined value to binding path");if("string"!==typeof e&&"number"!==typeof e&&"boolean"!==typeof e)throw new Error(`Attempting to convert ${typeof e} to a binding path.`);const t=this.normalizePath(String(e),o);t.updates&&(n=te(te({},n),t.updates));const r=t.path.join(".");if(""===r)throw new Error("Nested path resolved to an empty path");return r}},s=this.normalizePath(i,o);s.updates&&(n=te(te({},n),s.updates));const a=Object.keys(n);if(!r.readOnly&&a.length>0){const e=a.map((e=>[this.parse(e),n[e]]));r.set(e)}return this.getBindingForNormalizedResult(s)}}class se{constructor(){this.readDeps=new Set,this.writeDeps=new Set,this.namedDependencySets={},this.namedSet="core",this.createSubset("core"),this.createSubset("children")}createSubset(e,t=!1){!t&&this.namedDependencySets[e]||(this.namedDependencySets[e]={readDeps:new Set,writeDeps:new Set})}getDependencies(e){var t,r,n;return void 0!==e?null!=(n=null==(r=null==(t=this.namedDependencySets)?void 0:t[e])?void 0:r.readDeps)?n:new Set:this.readDeps}trackSubset(e){this.createSubset(e),this.namedSet=e}trackDefault(){this.namedSet="core"}getModified(e){var t,r,n;return void 0!==e?null!=(n=null==(r=null==(t=this.namedDependencySets)?void 0:t[e])?void 0:r.writeDeps)?n:new Set:this.writeDeps}readsBinding(e){return this.readDeps.has(e)}writesBinding(e){return this.writeDeps.has(e)}reset(){this.readDeps=new Set,this.writeDeps=new Set,this.namedDependencySets={},this.namedSet="core",this.createSubset("core",!0),this.createSubset("children",!0)}addReadDep(e,t=this.namedSet){var r,n;t&&(null==(n=null==(r=this.namedDependencySets)?void 0:r[t])||n.readDeps.add(e)),this.readDeps.add(e)}addWriteDep(e,t=this.namedSet){var r,n;t&&(null==(n=null==(r=this.namedDependencySets)?void 0:r[t])||n.writeDeps.add(e)),this.writeDeps.add(e)}addChildReadDep(e){this.addReadDep(e,"children")}}class ae extends se{constructor(e){super(),this.rootModel=e,this.set=this.set.bind(this),this.get=this.get.bind(this)}set(e,t){return e.forEach((([e])=>this.addWriteDep(e))),this.rootModel.set(e,t)}get(e,t){return this.addReadDep(e),this.rootModel.get(e,t)}delete(e,t){return this.addWriteDep(e),this.rootModel.delete(e,t)}}const le=new class{get(){}set(){return[]}delete(){}},ce=new H([]);function he(e,t,r){return r?{get:(n,i)=>{const o=null!=i?i:t;return e.get?e.get(n,o,r):null==r?void 0:r.get(n,o)},set:(n,i)=>{const o=null!=i?i:t;return e.set?e.set(n,o,r):null==r?void 0:r.set(n,o)},delete:(n,i)=>{const o=null!=i?i:t;return e.delete?e.delete(n,o,r):null==r?void 0:r.delete(n,o)}}:e}function de(e){if(0===e.length)return le;if(1===e.length)return he(e[0]);function t(t){var r;return null!=(r=e.reduce(((e,r)=>he(r,t,e)),void 0))?r:le}return{get:(e,r)=>{var n;return null==(n=t(r))?void 0:n.get(e,r)},set:(e,r)=>{var n;return null==(n=t(r))?void 0:n.set(e,r)},delete:(e,r)=>{var n;return null==(n=t(r))?void 0:n.delete(e,r)}}}class ue{constructor(e=[]){this.hooks={onSet:new n.ni},this.pipeline=e,this.effectiveDataModel=de(this.pipeline)}setMiddleware(e){this.pipeline=e,this.effectiveDataModel=de(e)}addMiddleware(e){this.pipeline=[...this.pipeline,e],this.effectiveDataModel=de(this.pipeline)}reset(e={}){this.pipeline.forEach((e=>{var t;"reset"in e&&(null==(t=e.reset)||t.call(e))})),this.set([[ce,e]])}set(e,t){const r=this.effectiveDataModel.set(e,t);return this.hooks.onSet.call(e),r}get(e,t){return this.effectiveDataModel.get(e,t)}delete(e,t){return this.effectiveDataModel.delete(e,t)}}class pe{constructor(e={}){this.model=e,this.get=this.get.bind(this),this.set=this.set.bind(this)}reset(e={}){this.model=e}get(e){return e&&e.asString()?d()(this.model,e.asArray()):this.model}set(e){const t=[];return e.forEach((([e,r])=>{const n=this.get(e);this.model=(0,u.tP)(this.model,e.asArray(),r),t.push({binding:e,oldValue:n,newValue:r})})),t}delete(e){const t=e.parent();if(t){const r=this.get(t);void 0!==r&&(Array.isArray(r)?this.model=(0,u.tP)(this.model,t.asArray(),(0,u.D3)(r,e.key())):this.model=(0,u.tP)(this.model,t.asArray(),(0,u.CE)(r,e.key())))}}}const ve=Symbol("Expression Node ID");function ge(e){return"object"===typeof e&&null!==e&&!Array.isArray(e)&&e.__id===ve}const fe=46,ye=40,we=123,me=125,be=!0,ke={"-":be,"!":be,"~":be,"+":be},Se={"=":3,"+=":3,"-=":3,"&=":3,"|=":3,"||":5,"&&":6,"|":7,"^":8,"&":9,"==":10,"!=":10,"===":10,"!==":10,"<":11,">":11,"<=":11,">=":11,"<<":12,">>":12,">>>":12,"+":13,"-":13,"*":14,"/":14,"%":14};function Ee(e,t){const r=new Error(`${e} at character ${t}`);throw r.index=t,r.description=e,r}function Oe(e,t){if(e&&t)return{start:e.start,end:t.end}}function Pe(e){let t=0;return Object.keys(e).forEach((r=>{r.length>t&&Object.prototype.hasOwnProperty.call(e,r)&&(t=r.length)})),t}const je=Pe(ke),Ae=Pe(Se),Te={true:!0,false:!1,null:null,undefined:void 0};function Ve(e){return Se[e]||0}function xe(e,t,r,n){let i;return i="||"===e||"&&"===e?"LogicalExpression":"="===e?"Assignment":"+="===e||"-="===e||"&="===e||"|="===e?"Modification":"BinaryExpression",{__id:ve,type:i,operator:e,left:t,right:r,location:n}}function Ce(e){return e>=48&&e<=57}function Ne(e){return 36===e||95===e||e>=65&&e<=90||e>=97&&e<=122}function _e(e){return 36===e||95===e||e>=65&&e<=90||e>=97&&e<=122||e>=48&&e<=57}function Be(e,t){var r;const n=null==(r=null==t?void 0:t.strict)||r,i=e.charAt,o=e.charCodeAt,{length:s}=e;let a=0;const l=e=>({start:{character:e},end:{character:a}});function c(t){return i.call(e,t)}function h(t){return o.call(e,t)}function d(){let e=h(a);for(;32===e||9===e;)e=h(++a)}function u(){const e=function(){let e,t,r,n=v(),i=p();if(!i)return n;let o={value:i,prec:Ve(i)},s=v();s||Ee(`Expected expression after ${i}`,a);const l=[n,o,s];i=p();for(;i&&(t=Ve(i),0!==t);){for(o={value:i,prec:t};l.length>2&&t<=l[l.length-2].prec;)s=l.pop(),i=l.pop().value,n=l.pop(),e=xe(i,n,s,Oe(n.location,s.location)),l.push(e);e=v(),e||Ee(`Expected expression after ${i}`,a),l.push(o,e),i=p()}r=l.length-1,e=l[r];for(;r>1;)e=xe(l[r-1].value,l[r-2],e,Oe(l[r-2].location,e.location)),r-=2;return e}();d();const t=a;if(a<s&&63===h(a)){a++;const r=u();if(r||Ee("Expected expression",a),d(),58===h(a)){a++;const n=u();return n||Ee("Expected expression",a),{__id:ve,type:"ConditionalExpression",test:e,consequent:r,alternate:n,location:l(t)}}Ee("Expected :",a)}return e}function p(){d();let t=e.substr(a,Ae),r=t.length;for(;r>0;){if(Object.prototype.hasOwnProperty.call(Se,t))return a+=r,t;t=t.substr(0,--r)}return!1}function v(){d();const t=h(a),r=a;if(Ce(t)||46===t)return function(){let e="";const t=a;for(;Ce(h(a));)e+=c(a++);if(h(a)===fe)for(e+=c(a++);Ce(h(a));)e+=c(a++);let r=c(a);if("e"===r||"E"===r){for(e+=c(a++),r=c(a),"+"!==r&&"-"!==r||(e+=c(a++));Ce(h(a));)e+=c(a++);Ce(h(a-1))||Ee(`Expected exponent (${e}${c(a)})`,a)}const n=h(a);Ne(n)?Ee(`Variable names cannot start with a number (${e}${c(a)})`,a):n===fe&&Ee("Unexpected period",a);return{__id:ve,type:"Literal",value:parseFloat(e),raw:e,location:l(t)}}();if(39===t||34===t)return g();if(Ne(t)||40===t)return function(){let e=h(a),t=e===ye?function(){a++;const e=u();if(d(),41===h(a))return a++,e;Ee("Unclosed (",a)}():f();const r=a;d(),e=h(a);for(;e===fe||91===e||e===ye;)a++,e===fe?(d(),t={__id:ve,type:"MemberExpression",computed:!1,object:t,property:f(),location:l(r)}):91===e?(t={__id:ve,type:"MemberExpression",computed:!0,object:t,property:u(),location:l(r)},d(),e=h(a),93!==e&&Ee("Unclosed [",a),a++):e===ye&&(t={__id:ve,type:"CallExpression",args:y(41),callTarget:t,location:l(r)}),d(),e=h(a);return t}();if(91===t)return function(){const e=a;return a++,{__id:ve,type:"ArrayExpression",elements:y(93),location:l(e)}}();if(n=t,i=h(a+1),n===we&&i===we)return function(){let e="",t=!1,r=1;const n=a;a+=2;for(;a<s;){const n=c(a++);if("}"===n&&h(a)===me){if(a++,r--,0===r){t=!0;break}e+="}}"}else"{"===n&&h(a)===we?(r++,e+="{{",a++):e+=n}t||Ee(`Unclosed brace after "${e}"`,a);return{__id:ve,type:"ModelRef",ref:e,location:l(n)}}();var n,i;if(t===we)return function(){const e=[];let t,r,n,i=!1,o=!0;const c=a;for(++a;a<s;){if(d(),n=h(a),125===n){t&&Ee("A key was defined but a value was not",a),a++,i=!0;break}o?(39!==n&&34!==n&&Ee("An object must start wtih a key",a),t=g(),d(),58===h(a)?(a++,o=!1):Ee("A colon must follow an object key",a)):(r=u(),e.push({key:t,value:r}),d(),n=h(a),44===n?a++:125!==n&&Ee("Please add a comma to add another key",a),o=!0,t=void 0,r=void 0),n=h(a)}return i||Ee("Unclosed brace in object",a),{__id:ve,type:"Object",attributes:e,location:l(c)}}();let o=e.substr(a,je),p=o.length;for(;p>0;){if(Object.prototype.hasOwnProperty.call(ke,o))return a+=p,{__id:ve,type:"UnaryExpression",operator:o,argument:v(),prefix:!0,location:l(r)};o=o.substr(0,--p)}return!1}function g(){const e=c(a++);let t="",r=!1;const n=a;for(;a<s;){let n=c(a++);if(n===e){r=!0;break}if("\\"===n)switch(n=c(a++),n){case"n":t+="\n";break;case"r":t+="\r";break;case"t":t+="\t";break;case"b":t+="\b";break;case"f":t+="\f";break;case"v":t+="\v"}else t+=n}return r||Ee(`Unclosed quote after "${t}"`,a),{__id:ve,type:"Literal",value:t,raw:`${e}${t}${e}`,location:l(n)}}function f(){const t=a;let r=h(t);for(Ne(r)?a++:Ee(`Unexpected ${c(a)}`,a);a<s&&(r=h(a),_e(r));)a++;const n=e.slice(t,a);return Object.prototype.hasOwnProperty.call(Te,n)?{__id:ve,type:"Literal",value:Te[n],raw:n,location:l(t)}:"this"===n?{__id:ve,type:"ThisExpression",location:l(t)}:{__id:ve,type:"Identifier",name:n,location:l(t)}}function y(e){const t=[];let r,i;for(;a<s;){if(d(),r=h(a),r===e){a++;break}44!==r?(i=u(),i&&"Compound"!==i.type||Ee("Expected comma",a),t.push(i)):a++}return n&&r!==e&&Ee(`Expected ${String.fromCharCode(e)}`,a),t}const w=[];try{for(;a<s;){const e=h(a);if(59===e||44===e){a++;continue}const t=u();t?w.push(t):n&&a<s&&Ee(`Unexpected "${c(a)}"`,a)}return 1===w.length?w[0]:{__id:ve,type:"Compound",body:w,location:l(0)}}catch(m){if(n||!(m instanceof Error))throw m;return{__id:ve,type:"Compound",body:w,location:l(0),error:m}}}const Me=(e,t,r,n)=>e.evaluate(t)?e.evaluate(r):n?e.evaluate(n):null;Me.resolveParams=!1;var Re=Object.freeze({__proto__:null,setDataVal:(e,t,r)=>{e.model.set([[t,r]])},getDataVal:(e,t)=>e.model.get(t),deleteDataVal:(e,t)=>e.model.delete(t),conditional:Me});function De(e){return!ge(e)&&("object"===typeof e&&null!==e&&!Array.isArray(e)&&"value"in e)}var Ie=Object.defineProperty,Ue=Object.defineProperties,$e=Object.getOwnPropertyDescriptors,Fe=Object.getOwnPropertySymbols,He=Object.prototype.hasOwnProperty,ze=Object.prototype.propertyIsEnumerable,Le=(e,t,r)=>t in e?Ie(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,We=(e,t)=>{for(var r in t||(t={}))He.call(t,r)&&Le(e,r,t[r]);if(Fe)for(var r of Fe(t))ze.call(t,r)&&Le(e,r,t[r]);return e},qe=(e,t)=>Ue(e,$e(t));const Ke=(e,t,r)=>e.evaluate(t)&&e.evaluate(r);Ke.resolveParams=!1;const Ge=(e,t,r)=>e.evaluate(t)||e.evaluate(r);Ge.resolveParams=!1;const Qe={"+":(e,t)=>e+t,"-":(e,t)=>e-t,"*":(e,t)=>e*t,"/":(e,t)=>e/t,"%":(e,t)=>e%t,"==":(e,t)=>e==t,"!=":(e,t)=>e!=t,">":(e,t)=>e>t,">=":(e,t)=>e>=t,"<":(e,t)=>e<t,"<=":(e,t)=>e<=t,"&&":Ke,"||":Ge,"!==":(e,t)=>e!==t,"===":(e,t)=>e===t,"|":(e,t)=>e|t,"&":(e,t)=>e&t,"+=":(e,t)=>e+t,"-=":(e,t)=>e-t,"&=":(e,t)=>e&t,"|=":(e,t)=>e|t},Je={"-":e=>-e,"+":e=>Number(e),"!":e=>!e};class Ze{constructor(e){this.vars={},this.hooks={resolve:new n.gg,resolveOptions:new n.gg,beforeEvaluate:new n.gg,onError:new n.oI},this.expressionsCache=new Map,this.operators={binary:new Map(Object.entries(Qe)),unary:new Map(Object.entries(Je)),expressions:new Map(Object.entries(Re))},this.defaultHookOptions=qe(We({},e),{evaluate:e=>this.evaluate(e,this.defaultHookOptions),resolveNode:e=>this._execAST(e,this.defaultHookOptions)}),this.hooks.resolve.tap("ExpressionEvaluator",this._resolveNode.bind(this)),this.evaluate=this.evaluate.bind(this)}reset(){this.expressionsCache.clear()}evaluate(e,t){var r;const n=this.hooks.resolveOptions.call(qe(We(We({},this.defaultHookOptions),t),{resolveNode:e=>this._execAST(e,n)}));let i=null!=(r=this.hooks.beforeEvaluate.call(e,n))?r:e;for(;De(i);)i=i.value;return"number"===typeof i||"boolean"===typeof i||void 0===i||null===i?i:ge(i)?this._execAST(i,n):Array.isArray(i)?i.reduce(((e,r)=>this.evaluate(r,t)),null):this._execString(String(i),n)}addExpressionFunction(e,t){this.operators.expressions.set(e,t)}addBinaryOperator(e,t){this.operators.binary.set(e,t)}addUnaryOperator(e,t){this.operators.unary.set(e,t)}setExpressionVariable(e,t){this.vars[e]=t}getExpressionVariable(e){return this.vars[e]}_execAST(e,t){return this.hooks.resolve.call(void 0,e,t)}_execString(e,t){var r;if(""===e)return e;const n=e.match(/^@\[(.*)\]@$/);let o,s=e;n&&([,s]=Array.from(n));try{o=null!=(r=this.expressionsCache.get(s))?r:Be(s,{strict:t.strict}),this.expressionsCache.set(s,o)}catch(a){if(t.throwErrors||!this.hooks.onError.call(a))throw new i.a6(`Error parsing expression: ${e}`,a);return}try{return this._execAST(o,t)}catch(a){if(t.throwErrors||!this.hooks.onError.call(a))throw new i.a6(`Error evaluating expression: ${e}`,a)}}_resolveNode(e,t,r){const{resolveNode:n,model:i}=r,o=qe(We({},r),{evaluate:e=>this.evaluate(e,r)});if("Literal"===t.type)return t.value;if("Identifier"===t.type)return this.vars[t.name];if("Compound"===t.type||"ThisExpression"===t.type)throw new Error(`Expression type: ${t.type} is not supported`);if("BinaryExpression"===t.type||"LogicalExpression"===t.type){const e=this.operators.binary.get(t.operator);return e?"resolveParams"in e?!1===e.resolveParams?e(o,t.left,t.right):e(o,n(t.left),n(t.right)):e(n(t.left),n(t.right)):void 0}if("UnaryExpression"===t.type){const e=this.operators.unary.get(t.operator);return e?"resolveParams"in e?e(o,!1===e.resolveParams?t.argument:n(t.argument)):e(n(t.argument)):void 0}if("Object"===t.type){const{attributes:e}=t,r={};return e.forEach((e=>{const t=n(e.key),i=n(e.value);r[t]=i})),r}if("CallExpression"===t.type){const e=t.callTarget.name,r=this.operators.expressions.get(e);if(!r)throw new Error(`Unknown expression function: ${e}`);if("resolveParams"in r&&!1===r.resolveParams)return r(o,...t.args);return r(o,...t.args.map((e=>n(e))))}if("ModelRef"===t.type)return i.get(t.ref,{context:{model:r.model}});if("MemberExpression"===t.type){return n(t.object)[n(t.property)]}if("Assignment"!==t.type){if("ConditionalExpression"===t.type){const e=n(t.test)?t.consequent:t.alternate;return n(e)}if("ArrayExpression"===t.type)return t.elements.map((e=>n(e)));if("Modification"===t.type){const e=this.operators.binary.get(t.operator);if(e){let r;return r="resolveParams"in e?!1===e.resolveParams?e(o,t.left,t.right):e(o,n(t.left),n(t.right)):e(n(t.left),n(t.right)),"ModelRef"===t.left.type?i.set([[t.left.ref,r]]):"Identifier"===t.left.type&&(this.vars[t.left.name]=r),r}return n(t.left)}}else{if("ModelRef"===t.left.type){const e=n(t.right);return i.set([[t.left.ref,e]]),e}if("Identifier"===t.left.type){const e=n(t.right);return this.vars[t.left.name]=e,e}}}}const Xe=()=>{};class Ye{constructor(){this.trace=Xe,this.debug=Xe,this.info=Xe,this.warn=Xe,this.error=Xe}}class et{constructor(){this.hooks={trace:new n.ni,debug:new n.ni,info:new n.ni,warn:new n.ni,error:new n.ni,log:new n.ni},this.logHandlers=new Set,this.trace=this.createHandler("trace"),this.debug=this.createHandler("debug"),this.info=this.createHandler("info"),this.warn=this.createHandler("warn"),this.error=this.createHandler("error")}createHandler(e){return(...t)=>{this.hooks[e].call(t),this.hooks.log.call(e,t),this.logHandlers.forEach((r=>r[e](...t)))}}addHandler(e){this.logHandlers.add(e)}removeHandler(e){this.logHandlers.delete(e)}}class tt{constructor(e){this.trace=this.createHandler("trace"),this.debug=this.createHandler("debug"),this.info=this.createHandler("info"),this.warn=this.createHandler("warn"),this.error=this.createHandler("error"),this.proxiedLoggerProvider=e}createHandler(e){return(...t)=>{const r=this.proxiedLoggerProvider();null==r||r[e](...t)}}}var rt=Object.defineProperty,nt=Object.defineProperties,it=Object.getOwnPropertyDescriptors,ot=Object.getOwnPropertySymbols,st=Object.prototype.hasOwnProperty,at=Object.prototype.propertyIsEnumerable,lt=(e,t,r)=>t in e?rt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,ct=(e,t)=>{for(var r in t||(t={}))st.call(t,r)&&lt(e,r,t[r]);if(ot)for(var r of ot(t))at.call(t,r)&&lt(e,r,t[r]);return e};const ht=e=>e;class dt{constructor(e){this.formatters=new Map,this.types=new Map,this.schema=new Map,this.bindingSchemaNormalizedCache=new Map,this.hooks={resolveTypeForBinding:new n.gg},this.schema=e?function(e){const t=new Map;if(!e.ROOT)return t;const r=[{node:e.ROOT,path:[],visited:new Set}];for(;r.length>0;){const n=r.shift();if(!n)break;const{node:i,path:o,visited:s}=n;Object.entries(i).forEach((([n,i])=>{const a=[...o,n],l=a.join(".");if(t.has(l))throw new Error("Path has already been processed. There's either a loop somewhere or a bug");if(s.has(i.type))throw new Error(`Path already contained type: ${i.type}. This likely indicates a loop in the schema`);t.set(l,i),i.isArray&&a.push("[]"),i.isRecord&&a.push("{}"),i.type&&e[i.type]&&r.push({path:a,node:e[i.type],visited:new Set([...s,i.type])})}))}return t}(e):new Map}addFormatters(e){e.forEach((e=>{this.formatters.set(e.name,e)}))}addDataTypes(e){e.forEach((e=>{this.types.set(e.type,e)}))}getValidationsForBinding(e){var t;const r=this.getApparentType(e);if(null==(t=null==r?void 0:r.validation)?void 0:t.length)return r.validation.map((e=>ct({severity:"error",trigger:"change"},e)))}normalizeBinding(e){const t=this.bindingSchemaNormalizedCache.get(e);if(t)return t;let r=e.asArray(),n=r.map((e=>"number"===typeof e?"[]":e)).join(".");return n&&(this.bindingSchemaNormalizedCache.set(e,n),r=n.split(".")),r.forEach((t=>{const i=r.map((e=>e===t?"{}":e)).join(".");this.schema.get(i)&&(this.bindingSchemaNormalizedCache.set(e,i),r=i.split("."),n=i)})),n}getType(e){return this.hooks.resolveTypeForBinding.call(this.schema.get(this.normalizeBinding(e)),e)}getApparentType(e){var t,r;const n=this.getType(e);if(void 0===n)return;const i=this.getTypeDefinition(null==n?void 0:n.type);return void 0===i?n:(o=ct(ct({},i),n),s={validation:[...null!=(t=n.validation)?t:[],...null!=(r=i.validation)?r:[]]},nt(o,it(s)));var o,s}getTypeDefinition(e){return this.types.get(e)}getFormatterForType(e){const t=e,{type:r}=t,n=((e,t)=>{var r={};for(var n in e)st.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&ot)for(var n of ot(e))t.indexOf(n)<0&&at.call(e,n)&&(r[n]=e[n]);return r})(t,["type"]),i=this.formatters.get(r);if(i)return{format:i.format?e=>{var t;return null==(t=i.format)?void 0:t.call(i,e,n)}:ht,deformat:i.deformat?e=>{var t;return null==(t=i.deformat)?void 0:t.call(i,e,n)}:ht}}getFormatter(e){const t=this.getApparentType(e);if(null==t?void 0:t.format)return this.getFormatterForType(t.format)}}const ut="{{",pt="}}";function vt(e){const t=e.indexOf(ut);if(-1===t)return;let r=1,n=t+ut.length,i=e.substring(t+ut.length);for(;r>0&&i.length>0;){const e=i.indexOf(pt);if(-1===e)break;const t=i.indexOf(ut);-1!==t&&t<e?(r++,i=i.substring(t+ut.length),n+=t+ut.length):(r--,i=i.substring(e+pt.length),n+=e+pt.length)}if(0!==r)throw new Error(`Unbalanced {{ and }} in exp: ${e}`);return{start:t,end:n}}function gt(e,t){const{model:r,formatted:n=!0}=t;let i=function(e,{evaluate:t}){if(!t)return e;const r=/@\[.*?\]@/;let n=e,i=n.match(r);for(;null!==i;){const o=i[0],s=n.indexOf(o),a=t(o.substr("@[".length,o.length-"@[".length-"]@".length));if(0===s&&o===e&&"string"!==typeof a)return a;n=n.substr(0,s)+a+n.substr(s+o.length),i=n.match(r)}return n}(e,t);if(!r||"string"!==typeof i||-1===i.indexOf(ut))return i;for(;-1!==i.indexOf(ut);){const e=vt(i);if(!e)return i;const{start:t,end:o}=e,s=i.substring(t+ut.length,o-ut.length).trim(),a=r.get(s,{formatted:n});if(0===t&&o===i.length&&"string"!==typeof a)return a;i=i.substr(0,t)+a+i.substr(o)}return i}function ft(e,t){switch(typeof e){case"string":return gt(e,t);case"object":{if(!e)return e;const r=Object.keys(e);let n=e;return r.length>0&&r.forEach((r=>{n=(0,u.tP)(n,[r],ft(e[r],t))})),n}default:return e}}function yt(e,t){return ft(e,t)}function wt(e,t){const r=new Map(e),n=t.parent(),i=t.key();if(r.forEach(((e,n)=>{(t===n||t.contains(n))&&r.delete(n)})),"number"===typeof i){Array.from(e.keys()).filter((e=>{if(n.contains(e)){const[t]=e.relative(n);return"number"===typeof t&&t>i}return!1})).sort().forEach((e=>{const[t,...i]=e.relative(n);if("number"===typeof t){const o=[t-1,...i],s=n.descendent(o);r.set(s,r.get(e)),r.delete(e)}}))}return r}var mt,bt,kt=Object.defineProperty,St=Object.defineProperties,Et=Object.getOwnPropertyDescriptors,Ot=Object.getOwnPropertySymbols,Pt=Object.prototype.hasOwnProperty,jt=Object.prototype.propertyIsEnumerable,At=(e,t,r)=>t in e?kt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;class Tt{constructor(e,t){this.validator=e,this.shadowModelPaths=new Map,this.logger=null==t?void 0:t.logger,this.shouldIncludeInvalid=null==t?void 0:t.shouldIncludeInvalid}set(e,t,r){const n=he(this,(i=((e,t)=>{for(var r in t||(t={}))Pt.call(t,r)&&At(e,r,t[r]);if(Ot)for(var r of Ot(t))jt.call(t,r)&&At(e,r,t[r]);return e})({},t),St(i,Et({includeInvalid:!0}))),r);var i;const o=[],s=new Set;e.forEach((([e,t])=>{this.shadowModelPaths.set(e,t),s.add(e)}));const a=[];this.shadowModelPaths.forEach(((e,t)=>{var r;const i=this.validator(t,n);void 0===i?o.push([t,e]):i instanceof Set?i.forEach((r=>{a.push(r.binding),r.isStrong||r.binding.asString()!==t.asString()||o.push([r.binding,e])})):s.has(t)&&(a.push(t),null==(r=this.logger)||r.debug(`Invalid value for path: ${t.asString()} - ${i.severity} - ${i.message}`))}));let l=[];if(r&&o.length>0){o.forEach((([e])=>this.shadowModelPaths.delete(e)));const e=r.set(o,t);if(0===a.length)return e;l=e}const c=a.map((e=>({binding:e,oldValue:n.get(e),newValue:n.get(e),force:!0})));return[...l,...c]}get(e,t,r){var n,i;let o=null==r?void 0:r.get(e,t);return(null!=(i=null==(n=this.shouldIncludeInvalid)?void 0:n.call(this,t))?i:!0===(null==t?void 0:t.includeInvalid))&&this.shadowModelPaths.forEach(((t,r)=>{r!==e?e.contains(r)&&(o=(0,u.tP)(o,r.relative(e),t)):o=t})),o}delete(e,t,r){return this.shadowModelPaths=wt(this.shadowModelPaths,e),null==r?void 0:r.delete(e,t)}}class Vt{constructor(){this.registry=new Map}get(e){return this.registry.get(e)}register(e,t){this.registry.set(e,t)}}function xt(e){var t;if(e)return"value"in e&&"object"===typeof e.value&&"string"===typeof(null==(t=e.value)?void 0:t.id)?e.value.id:void 0}(bt=mt||(mt={})).Asset="asset",bt.View="view",bt.Applicability="applicability",bt.Template="template",bt.Value="value",bt.MultiNode="multi-node",bt.Switch="switch",bt.Async="async",bt.Unknown="unknown",bt.Empty="empty";var Ct=Object.defineProperty,Nt=Object.defineProperties,_t=Object.getOwnPropertyDescriptors,Bt=Object.getOwnPropertySymbols,Mt=Object.prototype.hasOwnProperty,Rt=Object.prototype.propertyIsEnumerable,Dt=(e,t,r)=>t in e?Ct(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,It=(e,t)=>{for(var r in t||(t={}))Mt.call(t,r)&&Dt(e,r,t[r]);if(Bt)for(var r of Bt(t))Rt.call(t,r)&&Dt(e,r,t[r]);return e},Ut=(e,t)=>Nt(e,_t(t));const $t={type:mt.Empty};class Ft{constructor(){this.hooks={onParseObject:new n.gg,onCreateASTNode:new n.gg,determineNodeType:new n.oI,parseNode:new n.oI}}parseView(e){const t=this.parseObject(e,mt.View);if(!t)throw new Error("Unable to parse object into a view");return t}parseAsync(e,t,r){const n=this.parseObject((0,u.CE)(e,"async"),t,r),i=xt(n);return null!==n&&i?this.createASTNode({id:i,type:mt.Async,value:n},e):null}createASTNode(e,t){const r=this.hooks.onCreateASTNode.call(e,t);return void 0===r?e:r}hasTemplateValues(e,t){return Object.hasOwnProperty.call(e,"template")&&Array.isArray(null==e?void 0:e.template)&&e.template.length&&e.template.find((e=>e.output===t))}hasSwitchKey(e){return"staticSwitch"===e}parseObject(e,t=mt.Value,r={templateDepth:0}){var n;const i=this.hooks.determineNodeType.call(e);if(void 0!==i){const n=this.hooks.parseNode.call(e,t,r,i);if(n)return n}const o=(e,n,i=[])=>{if("object"!==typeof n||null===n)return{value:n,children:[]};const s=this.hooks.onParseObject.call(n,t);if(!s)return e;const a={children:[],value:e};return(Array.isArray(s)?s.map(((e,t)=>[t,e])):[...Object.entries(s),...Object.getOwnPropertySymbols(s).map((e=>[e,s[e]]))]).reduce(((e,t)=>{var n;const a=e,{children:l}=a,c=((e,t)=>{var r={};for(var n in e)Mt.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&Bt)for(var n of Bt(e))t.indexOf(n)<0&&Rt.call(e,n)&&(r[n]=e[n]);return r})(a,["children"]),[h,d]=t;if("asset"===h&&"object"===typeof d){const e=this.parseObject(d,mt.Asset,r);if(e)return Ut(It({},c),{children:[...l,{path:[...i,"asset"],value:e}]})}else{if(this.hooks.determineNodeType.call(h)===mt.Template&&Array.isArray(d)){const e=d.map((e=>{var t,n;const o=this.hooks.onCreateASTNode.call({type:mt.Template,depth:null!=(t=r.templateDepth)?t:0,data:e.data,template:e.value,dynamic:null!=(n=e.dynamic)&&n},e);if((null==o?void 0:o.type)===mt.MultiNode&&o.values.forEach((e=>{e.parent=o})),o)return{path:[...i,e.output],value:o}})).filter((e=>!!e));return Ut(It({},c),{children:[...l,...e]})}if(d&&this.hooks.determineNodeType.call(d)===mt.Switch||this.hasSwitchKey(h)){const e=this.hooks.parseNode.call(this.hasSwitchKey(h)?{[h]:d}:d,mt.Value,r,mt.Switch);if(e&&e.type===mt.Value&&1===(null==(n=e.children)?void 0:n.length)&&void 0===e.value){const t=e.children[0];return Ut(It({},c),{children:[...l,{path:[...i,h,...t.path],value:t.value}]})}if(e)return Ut(It({},c),{children:[...l,{path:[...i,h],value:e}]})}else if(d&&function(e){return Object.prototype.hasOwnProperty.call(e,"async")}(d)){const e=this.parseAsync(d,mt.Value,r);e&&l.push({path:[...i,h],value:e})}else if(d&&Array.isArray(d)){const e=d.map((e=>this.parseObject(e,mt.Value,r))).filter((e=>!!e));if(e.length>0){const t=this.hooks.onCreateASTNode.call({type:mt.MultiNode,override:!this.hasTemplateValues(s,h),values:e},d);if((null==t?void 0:t.type)===mt.MultiNode&&t.values.forEach((e=>{e.parent=t})),t)return Ut(It({},c),{children:[...l,{path:[...i,h],value:t}]})}}else{if(!d||"object"!==typeof d){return{children:l,value:(0,u.tP)(e.value,[...i,h],d)}}{const t=this.hooks.determineNodeType.call(d);if(t!==mt.Applicability){const t=o(e.value,d,[...i,h]);return{value:t.value,children:[...l,...t.children]}}{const e=this.hooks.parseNode.call(d,mt.Value,r,t);if(e)return Ut(It({},c),{children:[...l,{path:[...i,h],value:e}]})}}}}return e}),a)},{value:s,children:a}=o(void 0,e),l=void 0===s&&0===a.length?void 0:{type:t,value:s};if(void 0!==l&&a.length>0){const e=l;e.children=a,a.forEach((t=>{t.value.parent=e}))}return null!=(n=this.hooks.onCreateASTNode.call(l,e))?n:null}}var Ht=Object.defineProperty,zt=Object.defineProperties,Lt=Object.getOwnPropertyDescriptors,Wt=Object.getOwnPropertySymbols,qt=Object.prototype.hasOwnProperty,Kt=Object.prototype.propertyIsEnumerable,Gt=(e,t,r)=>t in e?Ht(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;function Qt(e,t){if(!e||!t)return!0;const r=Array.from(t.values()),n=Array.from(e.values());return void 0!==r.find((e=>!!n.find((t=>t===e||t.contains(e)||e.contains(t)))))}function Jt(e){return t=((e,t)=>{for(var r in t||(t={}))qt.call(t,r)&&Gt(e,r,t[r]);if(Wt)for(var r of Wt(t))Kt.call(t,r)&&Gt(e,r,t[r]);return e})({},e),r={data:{model:e.model,formatValue:(t,r)=>e.formatValue?e.formatValue(t,r):r,format:(t,r)=>e.format?e.format(F(t)?t:e.parseBinding(t),r):r},evaluate:t=>e.evaluator.evaluate(t,e)},zt(t,Lt(r));var t,r}function Zt(e,t){Array.isArray(e)?e.forEach((e=>{Zt(e,t)})):t.push(e)}var Xt=Object.defineProperty,Yt=Object.defineProperties,er=Object.getOwnPropertyDescriptors,tr=Object.getOwnPropertySymbols,rr=Object.prototype.hasOwnProperty,nr=Object.prototype.propertyIsEnumerable,ir=(e,t,r)=>t in e?Xt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,or=(e,t)=>{for(var r in t||(t={}))rr.call(t,r)&&ir(e,r,t[r]);if(tr)for(var r of tr(t))nr.call(t,r)&&ir(e,r,t[r]);return e},sr=(e,t)=>Yt(e,er(t));class ar{constructor(e,t){this.hooks={skipResolve:new n.gg,beforeUpdate:new n.ni,afterUpdate:new n.ni,resolveOptions:new n.gg,beforeResolve:new n.gg,resolve:new n.gg,afterResolve:new n.gg,afterNodeUpdate:new n.ni},this.root=e,this.options=t,this.resolveCache=new Map,this.ASTMap=new Map,this.logger=t.logger,this.idCache=new Set}getSourceNode(e){return this.ASTMap.get(e)}update(e){this.hooks.beforeUpdate.call(e);const t=new Map;this.idCache.clear();const r=new Map(this.ASTMap);this.ASTMap.clear();const n=this.computeTree(this.root,void 0,e,t,Jt(this.options),void 0,r);return this.resolveCache=t,this.hooks.afterUpdate.call(n.value),n.value}getResolveCache(){return new Map(this.resolveCache)}getPreviousResult(e){var t,r;if(!e)return;const n=0===this.resolveCache.size,i=xt(e);if(i){if(this.idCache.has(i))return void(n&&(e.type===mt.Asset||e.type===mt.View?null==(t=this.logger)||t.error(`Cache conflict: Found Asset/View nodes that have conflicting ids: ${i}, may cause cache issues.`):e.type===mt.Value&&(null==(r=this.logger)||r.info(`Cache conflict: Found Value nodes that have conflicting ids: ${i}, may cause cache issues. To improve performance make value node IDs globally unique.`))));this.idCache.add(i)}return this.resolveCache.get(e)}cloneNode(e){const t=(0,u.d9)(e);return Object.keys(t).forEach((e=>{if("parent"===e)return;const r=t[e];"object"===typeof r&&null!==r&&(t[e]=Array.isArray(r)?[...r]:or({},r))})),t}computeTree(e,t,r,n,i,o,s){var a,l,c;const h=new ae(i.data.model);h.trackSubset("core");const v=(g=function(e,t){function r(r,n){const i=F(r)?r:t(r,{get:e.get,set:e.set,readOnly:n});if(!i)throw new Error("Unable to parse binding");return i}return{get:(t,n)=>e.get(r(t,!0),n),set:(t,n)=>e.set(t.map((([e,t])=>[r(e,!1),t])),n),delete:(t,n)=>e.delete(r(t,!1),n)}}(h,this.options.parseBinding),{get:(e,t)=>g.get(e,or({context:{model:g}},t)),set:(e,t)=>g.set(e,or({context:{model:g}},t)),delete:(e,t)=>g.delete(e,or({context:{model:g}},t))});var g;const f=this.hooks.resolveOptions.call(sr(or({},i),{data:sr(or({},i.data),{model:v}),evaluate:e=>this.options.evaluator.evaluate(e,{model:v}),node:e}),e),y=this.getPreviousResult(e),w=null==y?void 0:y.dependencies,m=Qt(r,w),b=this.hooks.skipResolve.call(!m,e,f),k=sr(or({},this.cloneNode(e)),{parent:o}),S=null!=(a=this.hooks.beforeResolve.call(k,f))?a:{type:mt.Empty},E=S.type===mt.MultiNode&&(null==(l=null==o?void 0:o.parent)?void 0:l.type)===mt.MultiNode&&o.type===mt.Value;if(y&&b){const r=sr(or({},y),{updated:!1}),i=(e,t,r)=>{var o;const{node:a}=e;this.ASTMap.set(a,t);const l=sr(or({},e),{updated:!1});n.set(t,l);const c=e=>{var r;const n=null!=(r=s.get(e))?r:e,o=this.getPreviousResult(n);o&&i(o,n,t)};"children"in a?null==(o=a.children)||o.forEach((({value:e})=>c(e))):a.type===mt.MultiNode&&a.values.forEach(c),this.hooks.afterNodeUpdate.call(t,r,l)};return y.node.parent=o,i(y,e,t),r}S.parent=o,f.node=S,this.ASTMap.set(S,e);let O=this.hooks.resolve.call(void 0,S,f),P=!(0,p.J)(null==y?void 0:y.value,O);y&&!P&&(O=null==y?void 0:y.value);const j=new Set;if(h.trackSubset("children"),"children"in S){const t=null==(c=S.children)?void 0:c.map((t=>{const i=this.computeTree(t.value,e,r,n,f,S,s),{dependencies:o,node:a,updated:l,value:c}=i;if(o.forEach((e=>j.add(e))),c)if(a.type!==mt.MultiNode||a.override)O=(0,u.tP)(O,t.path,c);else{const e=(0,u.q5)(d()(O,t.path,[]),c);O=(0,u.tP)(O,t.path,e)}return P=P||l,sr(or({},t),{value:a})}));S.children=t}else if(S.type===mt.MultiNode){const t=[],i=E?null==o?void 0:o.parent:e,a=S.values.map((e=>{var o;const a=this.computeTree(e,i,r,n,f,S,s);return void 0!==a.value&&null!==a.value&&((null==(o=a.node.parent)?void 0:o.type)===mt.MultiNode&&Array.isArray(a.value)?a.value.forEach((e=>{Zt(e,t)})):t.push(a.value)),a.dependencies.forEach((e=>j.add(e))),P=P||a.updated,a.node}));S.values=a,O=t}j.forEach((e=>h.addChildReadDep(e))),h.trackSubset("core"),y&&!P&&(O=null==y?void 0:y.value),O=this.hooks.afterResolve.call(O,S,sr(or({},f),{getDependencies:e=>h.getDependencies(e)}));const A={node:S,updated:P,value:O,dependencies:new Set([...h.getDependencies(),...j])};return this.hooks.afterNodeUpdate.call(e,E?null==o?void 0:o.parent:t,A),n.set(e,A),A}}class lr{constructor(e){this.hooks={resolveTemplateSubstitutions:new n.gg},this.options=e}parseTemplate(e,t,r){const{template:n,depth:i}=t,o=r.data.model.get(t.data);if(!o)return null;if(!Array.isArray(o))throw new Error(`Template using '${t.data}' but is not an array`);const s=[];o.forEach(((r,o)=>{const a=this.hooks.resolveTemplateSubstitutions.call([{expression:new RegExp(`_index${i||""}_`),value:String(o)}],{depth:i,data:r,index:o});let l=JSON.stringify(n);for(const{expression:e,value:t}of a){let r="g";"object"===typeof e&&(r=`${e.flags}${e.global?"":"g"}`),l=l.replace(new RegExp(e,r),t)}const c=e(JSON.parse(l),mt.Value,{templateDepth:t.depth+1});c&&s.push(c)}));return{type:mt.MultiNode,override:!1,values:s}}applyParser(e){e.hooks.onCreateASTNode.tap("template",(t=>t&&t.type===mt.Template&&!t.dynamic?this.parseTemplate(e.parseObject.bind(e),t,this.options):t)),e.hooks.determineNodeType.tap("template",(e=>{if("template"===e)return mt.Template})),e.hooks.parseNode.tap("template",((t,r,n,i)=>{var o,s;if(i===mt.Template){const r=e.createASTNode({type:mt.Template,depth:null!=(o=n.templateDepth)?o:0,data:t.data,template:t.value,dynamic:null!=(s=t.dynamic)&&s},t);if(r)return r}}))}applyResolverHooks(e){e.hooks.beforeResolve.tap("template",((e,t)=>e&&e.type===mt.Template&&e.dynamic?this.parseTemplate(t.parseNode,e,t):e))}apply(e){e.hooks.parser.tap("template",this.applyParser.bind(this)),e.hooks.resolver.tap("template",this.applyResolverHooks.bind(this))}}const cr=(e,t)=>r=>{const n=r.indexOf(e);if(-1===n)return!1;const i=r.indexOf(t);return-1!==i&&n<i},hr=cr("{{","}}"),dr=cr("@[","]@");function ur(e,t){return function(e){return hr(e)||dr(e)}(e)?yt(e,{model:t.data.model,evaluate:t.evaluate}):e}function pr(e,t,r){if(null===e||void 0===e||"object"!==typeof e&&"string"!==typeof e)return e;if("string"===typeof e)return ur(e,t);let n=e;return Object.keys(e).forEach((i=>{if(r.has(i))return;const o=e[i];let s=o;"object"===typeof o?s=pr(o,t,r):"string"===typeof o&&(s=ur(o,t)),s!==o&&(n=(0,u.t8)(n,i,s))})),n}const vr=(e,t)=>{var r,n,i;const o=e.parent;if(!o)return[];if("children"in o){const s=t.getSourceNode(e);return null!=(i=null==(n=null==(r=o.children)?void 0:r.find((e=>e.value===s)))?void 0:n.path)?i:[]}return o.type!==mt.MultiNode?[]:vr(o,t)};class gr{constructor(){this.propertiesToSkipCache=new Map}applyResolver(e){e.hooks.resolve.tap("string-resolver",((t,r,n)=>{var i,o,s,a,l,c,h,d,u,p;if(r.type===mt.Empty||r.type===mt.Unknown)return null;if(r.type===mt.Value||r.type===mt.Asset||r.type===mt.View){let t;r.type===mt.Asset||r.type===mt.View?(t=new Set(null!=(s=null==(o=null==(i=r.plugins)?void 0:i.stringResolver)?void 0:o.propertiesToSkip)?s:["exp"]),(null==(a=r.value)?void 0:a.id)&&this.propertiesToSkipCache.set(r.value.id,t)):t=(null==(l=r.parent)?void 0:l.type)===mt.MultiNode&&((null==(h=null==(c=r.parent)?void 0:c.parent)?void 0:h.type)===mt.Asset||(null==(u=null==(d=r.parent)?void 0:d.parent)?void 0:u.type)===mt.View)&&(null==(p=r.parent.parent.value)?void 0:p.id)&&this.propertiesToSkipCache.has(r.parent.parent.value.id)?this.propertiesToSkipCache.get(r.parent.parent.value.id):new Set(["exp"]);const v=vr(r,e);return v.length>0&&v.some((e=>t.has(e.toString())))?r.value:pr(r.value,n,t)}return t}))}apply(e){e.hooks.resolver.tap("string-resolver",this.applyResolver.bind(this))}}class fr{applyResolver(e){e.hooks.beforeResolve.tap("applicability",((e,t)=>{let r=e;if((null==e?void 0:e.type)===mt.Applicability){if(!1===t.evaluate(e.expression))return null;r=e.value}return r}))}applyParser(e){e.hooks.determineNodeType.tap("applicability",(e=>{if(Object.prototype.hasOwnProperty.call(e,"applicability"))return mt.Applicability})),e.hooks.parseNode.tap("applicability",((t,r,n,i)=>{if(i===mt.Applicability){const i=e.parseObject((0,u.CE)(t,"applicability"),r,n);if(null!==i){const r=e.createASTNode({type:mt.Applicability,expression:t.applicability,value:i},t);return(null==r?void 0:r.type)===mt.Applicability&&(r.value.parent=r),r}}}))}apply(e){e.hooks.resolver.tap("applicability",this.applyResolver.bind(this)),e.hooks.parser.tap("applicability",this.applyParser.bind(this))}}var yr=Object.getOwnPropertySymbols,wr=Object.prototype.hasOwnProperty,mr=Object.prototype.propertyIsEnumerable;class br{constructor(e){this.options=e}resolveSwitch(e,t){for(const r of e.cases){if(t.evaluate(r.case))return r.value}return $t}applyParser(e){e.hooks.onCreateASTNode.tap("switch",(e=>e&&e.type===mt.Switch&&!e.dynamic?this.resolveSwitch(e,this.options):e)),e.hooks.determineNodeType.tap("switch",(e=>{if(Object.prototype.hasOwnProperty.call(e,"dynamicSwitch")||Object.prototype.hasOwnProperty.call(e,"staticSwitch"))return mt.Switch})),e.hooks.parseNode.tap("switch",((t,r,n,i)=>{if(i===mt.Switch){const r="dynamicSwitch"in t,i="dynamicSwitch"in t?t.dynamicSwitch:t.staticSwitch,o=[];i.forEach((t=>{const r=t,{case:i}=r,s=((e,t)=>{var r={};for(var n in e)wr.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&yr)for(var n of yr(e))t.indexOf(n)<0&&mr.call(e,n)&&(r[n]=e[n]);return r})(r,["case"]),a=e.parseObject(s,mt.Value,n);a&&o.push({case:i,value:a})}));const s=e.hooks.onCreateASTNode.call({type:mt.Switch,dynamic:r,cases:o},t);return(null==s?void 0:s.type)===mt.Switch&&s.cases.forEach((e=>{e.value.parent=s})),(null==s?void 0:s.type)===mt.Empty?null:null!=s?s:null}}))}applyResolver(e){e.hooks.beforeResolve.tap("switch",((e,t)=>e&&e.type===mt.Switch&&e.dynamic?this.resolveSwitch(e,t):e))}apply(e){e.hooks.parser.tap("switch",this.applyParser.bind(this)),e.hooks.resolver.tap("switch",this.applyResolver.bind(this))}}var kr=Object.defineProperty,Sr=Object.defineProperties,Er=Object.getOwnPropertyDescriptors,Or=Object.getOwnPropertySymbols,Pr=Object.prototype.hasOwnProperty,jr=Object.prototype.propertyIsEnumerable,Ar=(e,t,r)=>t in e?kr(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,Tr=(e,t)=>{for(var r in t||(t={}))Pr.call(t,r)&&Ar(e,r,t[r]);if(Or)for(var r of Or(t))jr.call(t,r)&&Ar(e,r,t[r]);return e};class Vr{constructor(e,t,r){this.allValidations=new Set,this.byBinding=new Map,this.logger=r,this.parse(e,t)}parse(e,t){var r;const n=e.validation;void 0!==n&&(Array.isArray(n)?n.forEach((e=>{var r;const n=Tr({trigger:"navigation",severity:"error"},e);this.allValidations.add(n);const{ref:i}=e;if(i){const e=t(i);this.byBinding.has(e)?null==(r=this.byBinding.get(e))||r.push(n):this.byBinding.set(e,[n])}})):null==(r=this.logger)||r.warn(`Unable to register view validations for id: ${e.id}. 'validation' property must be an Array.`))}getValidationsForBinding(e){return this.byBinding.get(e)}}class xr{constructor(e,t){this.hooks={onUpdate:new n.ni,parser:new n.ni,resolver:new n.ni,templatePlugin:new n.ni},this.initialView=e,this.resolverOptions=t;const r=Jt(t);new br(r).apply(this),(new fr).apply(this),(new gr).apply(this),this.templatePlugin=new lr(r),this.templatePlugin.apply(this)}updateAsync(){var e;const t=null==(e=this.resolver)?void 0:e.update();this.lastUpdate=t,this.hooks.onUpdate.call(t)}update(e){var t,r,n;if(void 0===this.rootNode){this.validationProvider=new Vr(this.initialView,this.resolverOptions.parseBinding,this.resolverOptions.logger),this.hooks.templatePlugin.call(this.templatePlugin);const e=new Ft;this.hooks.parser.call(e),this.rootNode=e.parseView(this.initialView),this.resolver=new ar(this.rootNode,(r=Tr({},this.resolverOptions),n={parseNode:e.parseObject.bind(e)},Sr(r,Er(n)))),this.hooks.resolver.call(this.resolver)}const i=null==(t=this.resolver)?void 0:t.update(e);return this.lastUpdate===i?this.lastUpdate:(this.lastUpdate=i,this.hooks.onUpdate.call(i),i)}getValidationsForBinding(e){var t;return null==(t=this.validationProvider)?void 0:t.getValidationsForBinding(e)}}var Cr=Object.defineProperty,Nr=Object.getOwnPropertySymbols,_r=Object.prototype.hasOwnProperty,Br=Object.prototype.propertyIsEnumerable,Mr=(e,t,r)=>t in e?Cr(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,Rr=(e,t,r)=>new Promise(((n,i)=>{var o=e=>{try{a(r.next(e))}catch(t){i(t)}},s=e=>{try{a(r.throw(e))}catch(t){i(t)}},a=e=>e.done?n(e.value):Promise.resolve(e.value).then(o,s);a((r=r.apply(e,t)).next())}));class Dr{constructor(e,t,r){this.isTransitioning=!1,this.hooks={beforeStart:new n.oI,onStart:new n.ni,onEnd:new n.ni,skipTransition:new n.oI,beforeTransition:new n.gg,resolveTransitionNode:new n.gg,transition:new n.ni,afterTransition:new n.ni},this.id=e,this.flow=t,this.log=null==r?void 0:r.logger,this.history=[],this.hooks.transition.tap("startPromise",((e,t)=>Rr(this,null,(function*(){const e=t.value;this.flowPromise&&"END"===e.state_type&&this.flowPromise.resolve(e)}))))}start(){return Rr(this,null,(function*(){var e;if(this.flowPromise)return null==(e=this.log)||e.warn("Already called start for flow"),this.flowPromise.promise;this.flow=this.hooks.beforeStart.call(this.flow)||this.flow,this.flow.onStart&&this.hooks.onStart.call(this.flow.onStart);const t=this.flow.startState;return t?(this.flowPromise=g()(),this.pushHistory(t),this.flowPromise.promise):Promise.reject(new Error("No 'startState' defined for flow"))}))}transition(e,t){var r,n,i,o,s,a,l;if(this.isTransitioning)throw new Error(`Transitioning while ongoing transition from ${null==(r=this.currentState)?void 0:r.name} is in progress is not supported`);if("END"===(null==(n=this.currentState)?void 0:n.value.state_type))return void(null==(i=this.log)||i.warn(`Skipping transition using ${e}. Already at and END state`));if(void 0===this.currentState)throw new Error("Cannot transition when there's no current state");if(null==t?void 0:t.force)null==(o=this.log)||o.debug("Forced transition. Skipping validation checks");else{if(this.hooks.skipTransition.call(this.currentState))return void(null==(s=this.log)||s.debug(`Skipping transition from ${this.currentState.name} b/c hook told us to`))}const c=this.hooks.beforeTransition.call(this.currentState.value,e);if(!("transitions"in c))throw new Error(`No transitions defined for ${this.currentState.value}`);const{transitions:h}=c,d=h[e]||h["*"];if(void 0!==d)return null==(l=this.log)||l.debug(`Transitioning from ${this.currentState.name} to ${d} using ${e} `),this.pushHistory(d,t);null==(a=this.log)||a.warn(`No transition from ${this.currentState.name} using ${e} or *`)}pushHistory(e,t){var r;if(!Object.prototype.hasOwnProperty.call(this.flow,e))throw new Error(`No flow definition for: ${e} was found.`);let n=this.flow[e];if(!this.flow[e]||"object"!==typeof n||!("state_type"in n))return void(null==(r=this.log)||r.error(`Flow doesn't contain any states named: ${e}`));const i=this.currentState;this.isTransitioning=!0,n=this.hooks.resolveTransitionNode.call(n);const o={name:e,value:n};this.currentState=o,this.history.push(e),"END"===o.value.state_type&&this.flow.onEnd&&this.hooks.onEnd.call(this.flow.onEnd),this.hooks.transition.call(i,((e,t)=>{for(var r in t||(t={}))_r.call(t,r)&&Mr(e,r,t[r]);if(Nr)for(var r of Nr(t))Br.call(t,r)&&Mr(e,r,t[r]);return e})({},o)),this.isTransitioning=!1,this.hooks.afterTransition.call(this)}}var Ir=(e,t,r)=>new Promise(((n,i)=>{var o=e=>{try{a(r.next(e))}catch(t){i(t)}},s=e=>{try{a(r.throw(e))}catch(t){i(t)}},a=e=>e.done?n(e.value):Promise.resolve(e.value).then(o,s);a((r=r.apply(e,t)).next())}));class Ur{constructor(e,t){this.hooks={flow:new n.ni},this.navigation=e,this.navStack=[],this.log=null==t?void 0:t.logger,this.start=this.start.bind(this),this.run=this.run.bind(this),this.transition=this.transition.bind(this),this.addNewFlow=this.addNewFlow.bind(this)}transition(e,t){if(void 0===this.current)throw new Error("Not currently in a flow. Cannot transition.");this.current.transition(e,t)}addNewFlow(e){this.navStack.push(e),this.current=e,this.hooks.flow.call(e)}run(e){return Ir(this,null,(function*(){var t;if(!Object.prototype.hasOwnProperty.call(this.navigation,e))return Promise.reject(new Error(`No flow defined for: ${e}`));const r=this.navigation[e];if(null===r||"object"!==typeof r)return Promise.reject(new Error(`Flow: ${e} needs to be an object`));null==(t=this.log)||t.debug(`Starting flow: ${e}`);const n=new Dr(e,r,{logger:this.log});this.addNewFlow(n),n.hooks.afterTransition.tap("flow-controller",(e=>{var t,r,n;if("FLOW"===(null==(t=e.currentState)?void 0:t.value.state_type)){const t=null==(r=e.currentState)?void 0:r.value.ref;null==(n=this.log)||n.debug(`Loading subflow ${t}`),this.run(t).then((t=>{var r;null==(r=this.log)||r.debug(`Subflow ended. Using outcome: ${t.outcome}`),e.transition(null==t?void 0:t.outcome)}))}}));const i=yield n.start();if(this.navStack.pop(),this.navStack.length>0){const e=0;this.current=this.navStack[e]}return i}))}start(){return Ir(this,null,(function*(){return this.navigation.BEGIN?this.run(this.navigation.BEGIN):Promise.reject(new Error("Must supply a BEGIN state"))}))}}const $r=/%([a-zA-Z]+)/g;var Fr=Object.defineProperty,Hr=Object.defineProperties,zr=Object.getOwnPropertyDescriptors,Lr=Object.getOwnPropertySymbols,Wr=Object.prototype.hasOwnProperty,qr=Object.prototype.propertyIsEnumerable,Kr=(e,t,r)=>t in e?Fr(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,Gr=(e,t)=>{for(var r in t||(t={}))Wr.call(t,r)&&Kr(e,r,t[r]);if(Lr)for(var r of Lr(t))qr.call(t,r)&&Kr(e,r,t[r]);return e},Qr=(e,t)=>Hr(e,zr(t));const Jr="validation-binding-tracker";class Zr{constructor(e){this.trackedBindings=new Set,this.options=e}getBindings(){return this.trackedBindings}trackBinding(e){var t,r;this.trackedBindings.has(e)||(this.trackedBindings.add(e),null==(r=null==(t=this.options.callbacks)?void 0:t.onAdd)||r.call(t,e))}applyResolver(e){this.trackedBindings.clear();const t=new Map,r=new Map;let n;const i=new Map;let o=new Map,s=new Map;const a=new Map;e.hooks.beforeUpdate.tap(Jr,(e=>{n=e})),e.hooks.skipResolve.tap(Jr,((e,t)=>{const r=o.get(t);if(!e||!n||!r)return e;return 0===new Set([...n].filter((e=>r.has(e)))).size})),e.hooks.resolveOptions.tap(Jr,((e,n)=>{if(void 0===e.validation)return e;t.delete(n);const i=e=>{var i,o,s,a;const l=F(e)?e:this.options.parseBinding(e);t.has(n)?null==(i=t.get(n))||i.add(l):t.set(n,new Set([l]));let{parent:c}=n;for(;c;){if(r.has(c)){null==(o=r.get(c))||o.add(n);break}c=c.parent}this.trackedBindings.add(l),null==(a=null==(s=this.options.callbacks)?void 0:s.onAdd)||a.call(s,l)};return Qr(Gr({},e),{validation:Qr(Gr({},e.validation),{get:(t,r)=>{var n,o;(null==r?void 0:r.track)&&i(t);const s=null==(o=null==(n=e.validation)?void 0:n._getValidationForBinding(t))?void 0:o.getAll(r);return null==s?void 0:s.find((e=>"field"===e.displayTarget||void 0===e.displayTarget))},getValidationsForBinding(t,r){var n,o,s;return(null==r?void 0:r.track)&&i(t),null!=(s=null==(o=null==(n=e.validation)?void 0:n._getValidationForBinding(t))?void 0:o.getAll(r))?s:[]},getChildren:t=>{var r;const i=new Array;return null==(r=o.get(n))||r.forEach((r=>{var n,o;const s=null==(o=null==(n=e.validation)?void 0:n._getValidationForBinding(r))?void 0:o.get();!s||void 0!==t&&t!==s.displayTarget||i.push(s)})),i},getValidationsForSection:()=>{var t;const r=new Array;return null==(t=a.get(n))||t.forEach((t=>{var n,i;const o=null==(i=null==(n=e.validation)?void 0:n._getValidationForBinding(t))?void 0:i.get();o&&"section"===o.displayTarget&&r.push(o)})),r},register:e=>{"section"===(null==e?void 0:e.type)&&(r.has(n)||r.set(n,new Set))},track:i})})})),e.hooks.afterNodeUpdate.tap(Jr,((n,l,c)=>{var h,d;if(l&&function(e,t){var r;i.has(t)?null==(r=i.get(t))||r.add(e):i.set(t,new Set([e]))}(n,l),c.updated){const e=new Set(t.get(n));null==(h=i.get(n))||h.forEach((t=>{var r;null==(r=s.get(t))||r.forEach((t=>e.add(t)))})),s.set(n,e)}else s.set(n,null!=(d=o.get(n))?d:new Set);n===e.root&&(this.trackedBindings=new Set(s.get(n)),o=s,a.clear(),r.forEach(((e,r)=>{const n=new Set;e.forEach((e=>{var r;null==(r=t.get(e))||r.forEach(n.add,n)})),a.set(r,n)})),i.clear(),t.clear(),r.clear(),s=new Map)}))}apply(e){e.hooks.resolver.tap(Jr,this.applyResolver.bind(this))}}var Xr=Object.defineProperty,Yr=Object.defineProperties,en=Object.getOwnPropertyDescriptors,tn=Object.getOwnPropertySymbols,rn=Object.prototype.hasOwnProperty,nn=Object.prototype.propertyIsEnumerable,on=(e,t,r)=>t in e?Xr(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,sn=(e,t)=>{for(var r in t||(t={}))rn.call(t,r)&&on(e,r,t[r]);if(tn)for(var r of tn(t))nn.call(t,r)&&on(e,r,t[r]);return e},an=(e,t)=>Yr(e,en(t));const ln=Symbol.for("validation-provider-name");class cn{constructor(e,t,r,n){this.applicableValidations=[],this.validationsByState={load:[],change:[],navigation:[]},this.onDismiss=t,e.forEach((e=>{const{trigger:t}=e;if(this.validationsByState[t]){const r={value:n=e,type:n.severity,state:"none",isBlockingNavigation:!1};this.validationsByState[t].push(r)}else null==r||r.warn(`Unknown validation trigger: ${t}`);var n})),this.weakBindings=null!=n?n:new Set}get allValidations(){return Object.values(this.validationsByState).flat()}checkIfBlocking(e){if("active"===e.state){const{isBlockingNavigation:t}=e;return t}return!1}getAll(){return this.applicableValidations.reduce(((e,t)=>("active"===t.state&&t.response&&e.push(an(sn({},t.response),{blocking:this.checkIfBlocking(t)})),e)),[])}get(){const e=this.applicableValidations.find((e=>"active"===e.state&&e.response));if("active"===(null==e?void 0:e.state))return an(sn({},e.response),{blocking:this.checkIfBlocking(e)})}runApplicableValidations(e,t,r){this.applicableValidations=this.applicableValidations.map((n=>{var i,o,s;if("dismissed"===n.state)return n;const a=null!=(i=n.value.blocking)?i:"warning"!==n.value.severity||"once",l=(0,u.tP)(n,["value","blocking"],a),c=!0===a||"once"===a&&!t;if("navigation"===r&&"active"===l.state&&!0!==l.value.blocking&&"warning"===l.value.severity){const e=l;return!e.dismissable||!e.response.dismiss||"once"===e.response.blocking&&e.response.blocking?("once"===(null==e?void 0:e.response.blocking)&&(e.response.blocking=!1),e.dismissable=!0):e.response.dismiss(),e}const h=e(l.value),d={type:l.type,value:l.value,state:h?"active":"none",isBlockingNavigation:c,dismissable:"warning"===l.value.severity&&"navigation"===r,response:h?an(sn({},l.value),{message:null!=(o=h.message)?o:"Something is broken",severity:l.value.severity,displayTarget:null!=(s=l.value.displayTarget)?s:"field"}):void 0};return"active"===d.state&&"warning"===l.value.severity&&(d.response.dismiss=()=>{var e;d.state="dismissed",null==(e=this.onDismiss)||e.call(this)}),d}))}update(e,t,r){const n=[];"load"===e&&void 0!==this.currentPhase||("navigation"!==this.currentPhase&&e!==this.currentPhase?("load"===e?(this.currentPhase="load",this.applicableValidations=[...this.validationsByState.load]):"change"===e&&"load"===this.currentPhase?(this.currentPhase="change",this.applicableValidations=[...this.applicableValidations,...this.validationsByState.change]):"navigation"!==e||"load"!==this.currentPhase&&"change"!==this.currentPhase||(this.applicableValidations.forEach((e=>{"error"===e.type&&"active"===e.state&&!1===e.isBlockingNavigation||n.push(e)})),this.applicableValidations=[...n,...this.validationsByState.navigation,..."load"===this.currentPhase?this.validationsByState.change:[]],this.currentPhase="navigation"),this.runApplicableValidations(r,t,e)):this.runApplicableValidations(r,t,e))}}class hn{constructor(e,t){this.hooks={createValidatorRegistry:new n.ni,onAddValidation:new n.gg,onRemoveValidation:new n.gg,resolveValidationProviders:new n.gg,onTrackBinding:new n.ni},this.validations=new Map,this.weakBindingTracker=new Set,this.schema=e,this.options=t,this.reset()}setOptions(e){this.options=e}getDataMiddleware(){return[{set:(e,t,r)=>{var n;return null!=(n=null==r?void 0:r.set(e,t))?n:[]},get:(e,t,r)=>null==r?void 0:r.get(e,t),delete:(e,t,r)=>(this.validations=wt(this.validations,e),null==r?void 0:r.delete(e,t))},new Tt((e=>{var t;if(!this.options)return;this.updateValidationsForBinding(e,"change",this.options);const r=this.getValidationForBinding(e);if("error"===(null==(t=null==r?void 0:r.get())?void 0:t.severity))return r.get();const n=new Set;return this.validations.forEach(((t,r)=>{var i;Qt(new Set([e]),t.weakBindings)&&"error"===(null==(i=null==t?void 0:t.get())?void 0:i.severity)&&(null==t||t.weakBindings.forEach((e=>{e===r?n.add({binding:e,isStrong:!0}):n.add({binding:e,isStrong:!1})})))})),n.size>0?n:void 0}),{logger:new tt((()=>{var e;return null==(e=this.options)?void 0:e.logger}))})]}getValidationProviders(){return this.providers||(this.providers=this.hooks.resolveValidationProviders.call([{source:"schema",provider:this.schema},{source:"view",provider:{getValidationsForBinding:e=>{var t,r;return null==(r=null==(t=this.viewValidationProvider)?void 0:t.getValidationsForBinding)?void 0:r.call(t,e)},getValidationsForView:()=>{var e,t;return null==(t=null==(e=this.viewValidationProvider)?void 0:e.getValidationsForView)?void 0:t.call(e)}}}])),this.providers}reset(){this.validations.clear(),this.tracker=void 0}onView(e){if(this.validations.clear(),!this.options)return;const t=new Zr(an(sn({},this.options),{callbacks:{onAdd:t=>{if(!this.options||void 0!==this.getValidationForBinding(t))return;const r=this.options.model.get(t);r!==this.options.model.get(t,{ignoreDefaultValue:!0})&&this.options.model.set([[t,r]],{silent:!0}),this.updateValidationsForBinding(t,"load",this.options,(()=>{e.update(new Set([t]))})),this.hooks.onTrackBinding.call(t)}}}));this.tracker=t,this.viewValidationProvider=e,t.apply(e)}updateValidationsForBinding(e,t,r,n){var i;const o=null!=r?r:this.options;if(!o)throw new Error("Context is required for executing validations");if("load"===t){const t=this.getValidationProviders().reduce(((t,r)=>{var n,i,o,s;return t.push(...null!=(s=null==(o=null==(i=(n=r.provider).getValidationsForBinding)?void 0:i.call(n,e))?void 0:o.map((e=>an(sn({},e),{[ln]:r.source}))))?s:[]),t}),[]);if(0===t.length)return;this.validations.set(e,new cn(t,n,null==(i=this.options)?void 0:i.logger))}const s=this.validations.get(e);null==s||s.update(t,!0,(t=>{const r=this.validationRunner(t,e,o);if(this.weakBindingTracker.size>0){const t=this.validations.get(e);this.weakBindingTracker.forEach((e=>t.weakBindings.add(e)))}return r?{message:r.message}:void 0})),"load"!==t&&this.validations.forEach(((r,n)=>{n!==e&&Qt(new Set([e]),r.weakBindings)&&r.update(t,!0,(e=>{const t=this.validationRunner(e,n,o);return t?{message:t.message}:void 0}))}))}validationRunner(e,t,r=this.options){var n;if(!r)throw new Error("No context provided to validation runner");const i=null!=(n=e.handler)?n:this.getValidator(e.type),o=new Set,s={get:(e,n)=>(o.add(F(e)?t:r.parseBinding(e)),r.model.get(e,an(sn({},n),{includeInvalid:!0}))),set:r.model.set,delete:r.model.delete},a=null==i?void 0:i(an(sn({},r),{evaluate:(e,t={model:s})=>r.evaluate(e,t),model:s,validation:e,schemaType:this.schema.getType(t)}),r.model.get(t,{includeInvalid:!0,formatted:"formatted"===e.dataTarget}),e);if(this.weakBindingTracker=o,a){let{message:t}=a;const{parameters:n}=a;return e.message&&(t=yt(e.message,{model:s,evaluate:r.evaluate}),n&&(t=function(e,t){return e.slice().replace($r,(e=>t[e.slice(1)]||e))}(t,n))),{message:t}}}updateValidationsForView(e){const t="navigation"===e,r=this.activeBindings,n=t=>{this.getBindings().forEach((r=>{var n;null==(n=this.validations.get(r))||n.update(e,t,(e=>{if(this.options)return this.validationRunner(e,r,this.options)}))}))};if(n(!t),t){const{activeBindings:e}=this;(function(e,t){if(e.size>t.size)return!1;for(const r of e)if(!t.has(r))return!1;return!0})(e,r)&&n(!0)}}get activeBindings(){return new Set(Array.from(this.getBindings()).filter((e=>{var t;return void 0!==(null==(t=this.validations.get(e))?void 0:t.get())})))}getValidator(e){if(this.validatorRegistry)return this.validatorRegistry.get(e);const t=new Vt;return this.hooks.createValidatorRegistry.call(t),this.validatorRegistry=t,t.get(e)}getBindings(){var e,t;return null!=(t=null==(e=this.tracker)?void 0:e.getBindings())?t:new Set}trackBinding(e){var t;null==(t=this.tracker)||t.trackBinding(e)}validateView(e="navigation"){this.updateValidationsForView(e);const t=new Map;let r=!0;return this.getBindings().forEach((n=>{var i;const o=null==(i=this.getValidationForBinding(n))?void 0:i.getAll();null==o||o.forEach((i=>{var o;"navigation"===e&&i.blocking&&(null==(o=this.options)||o.logger.debug(`Validation on binding: ${n.asString()} is preventing navigation. ${JSON.stringify(i)}`),r=!1),t.has(n)||t.set(n,i)}))})),{canTransition:r,validations:t.size?t:void 0}}getValidationForBinding(e){return this.validations.get(e)}forView(e){return{_getValidationForBinding:t=>this.getValidationForBinding(F(t)?t:e(t)),getAll:()=>{const e=this.getBindings();if(0===e.size)return;const t=new Map;return e.forEach((e=>{var r;const n=null==(r=this.getValidationForBinding(e))?void 0:r.get();n&&t.set(e,n)})),0===t.size?void 0:t},get(){throw new Error("Error Access be provided by the view plugin")},getValidationsForBinding(){throw new Error("Error rollup should be provided by the view plugin")},getChildren(){throw new Error("Error rollup should be provided by the view plugin")},getValidationsForSection(){throw new Error("Error rollup should be provided by the view plugin")},track:()=>{throw new Error("Tracking should be provided by the view plugin")},register:()=>{throw new Error("Section functionality should be provided by the view plugin")},type:t=>this.schema.getType(F(t)?t:e(t))}}}class dn{constructor(e){this.updateCallback=e,this.state=new Map}removeKey(e){this.state.delete(e)}reset(){this.state.clear()}useSharedState(e){return t=>(this.state.has(e)||this.state.set(e,t),[this.state.get(e),t=>{var r;const n=this.state.get(e);this.state.set(e,t),n!==t&&(null==(r=this.updateCallback)||r.call(this))}])}getLocalStateFunction(e,t){return r=>{this.state.has(e)||this.state.set(e,[]),this.state.has(t)||this.state.set(t,0);const n=this.state.get(e),i=this.state.get(t);this.state.set(t,i+1),n.length<=i&&n.push(r);return[n[i],e=>{var t;const r=n[i];n[i]=e,r!==e&&(null==(t=this.updateCallback)||t.call(this))}]}}}function un(e,t){return e===t||!!e.parent&&un(e.parent,t)}class pn{constructor(e){this.registry=e,this.stateStore=new Map,this.beforeResolveSymbol=Symbol("before resolve"),this.resolveSymbol=Symbol("resolve"),this.beforeResolveCountSymbol=Symbol("before resolve count"),this.resolveCountSymbol=Symbol("resolve count")}apply(e){e.hooks.view.tap("asset-transform",(e=>{this.stateStore.clear(),e.hooks.resolver.tap("asset-transform",(t=>{let r;const n=(t,n)=>{let i;const o=n===this.resolveSymbol?this.resolveCountSymbol:this.beforeResolveCountSymbol,s=this.stateStore.get(t);return s?(i=s,i.removeKey(o)):(i=new dn((()=>{(t=>{r=t,e.update(new Set)})(t)})),this.stateStore.set(t,i)),{useSharedState:e=>i.useSharedState(e),useLocalState:e=>i.getLocalStateFunction(n,o)(e)}};t.hooks.beforeResolve.tap("asset-transform",((e,t)=>{var r;if(e&&("asset"===e.type||"view"===e.type)){const i=this.registry.get(e.value);if(null==i?void 0:i.beforeResolve){const o=n(null!=(r=t.node)?r:e,this.beforeResolveSymbol);return i.beforeResolve(e,t,o)}}return e})),t.hooks.afterUpdate.tap("asset-transform",(()=>{r=void 0})),t.hooks.skipResolve.tap("asset-transform",((e,t)=>{if(!e||!r)return e;const n=un(r,t),i=un(t,r);return!n&&!i})),t.hooks.afterResolve.tap("asset-transform",((e,r,i)=>{if(r.type!==mt.Asset&&r.type!==mt.View)return e;const o=t.getSourceNode(r);if(!o)return e;const s=this.registry.get(e);if(null==s?void 0:s.resolve){const t=n(o,this.resolveSymbol);return null==s?void 0:s.resolve(e,i,t)}return e}))}))}))}}class vn{constructor(e,t){this.hooks={resolveView:new n.gg,view:new n.ni},this.transformRegistry=new w.B,this.optimizeUpdates=!0,this.viewOptions=t,this.viewMap=e.reduce(((e,t)=>(e[t.id]=t,e)),{}),new pn(this.transformRegistry).apply(this),t.flowController.hooks.flow.tap("viewController",(e=>{e.hooks.transition.tap("viewController",((e,t)=>{"VIEW"===t.value.state_type?this.onView(t.value):this.currentView=void 0}))}));const r=(e,t=!1)=>{this.currentView&&(this.optimizeUpdates?this.queueUpdate(e,t):this.currentView.update())};t.model.hooks.onUpdate.tap("viewController",((e,t)=>{var n;r(new Set(e.map((e=>e.binding))),null!=(n=null==t?void 0:t.silent)&&n)})),t.model.hooks.onDelete.tap("viewController",(e=>{const t=e.parent(),n=e.key();r("number"===typeof n&&t?new Set([t]):new Set([e]))}))}queueUpdate(e,t=!1){var r;(null==(r=this.pendingUpdate)?void 0:r.changedBindings)?this.pendingUpdate.changedBindings=new Set([...this.pendingUpdate.changedBindings,...e]):this.pendingUpdate={changedBindings:e,scheduled:!1},this.pendingUpdate.scheduled||t||(this.pendingUpdate.scheduled=!0,y()((()=>{var e,t;const r=null==(e=this.pendingUpdate)?void 0:e.changedBindings;this.pendingUpdate=void 0,null==(t=this.currentView)||t.update(r)})))}getViewForRef(e){if(this.viewMap[e])return this.viewMap[e];const t=Object.keys(this.viewMap).find((t=>e===gt(t,{model:this.viewOptions.model,evaluate:this.viewOptions.evaluator.evaluate})));return t&&this.viewMap[t]?this.viewMap[t]:void 0}onView(e){const t=e.ref,r=this.hooks.resolveView.call(this.getViewForRef(t),t,e);if(!r)throw new Error(`No view with id ${t}`);const n=new xr(r,this.viewOptions);this.currentView=n,this.hooks.view.call(n),n.update()}}class gn{constructor(e,t){this.controller=e,this.logger=t}get(e,t){return this.controller.get(e,t)}set(e,t){var r;return null==(r=this.logger)||r.error("Error: Tried to set in a read only instance of the DataController"),[]}delete(e,t){var r;null==(r=this.logger)||r.error("Error: Tried to delete in a read only instance of the DataController")}}class fn{constructor(e,t){this.hooks={resolve:new n.gg,resolveDataStages:new n.gg,resolveDefaultValue:new n.oI,onDelete:new n.ni,onSet:new n.ni,onGet:new n.ni,onUpdate:new n.ni,format:new n.gg,deformat:new n.gg,serialize:new n.gg},this.logger=t.logger;const r=t.middleware||[];this.baseMiddleware=[new pe(e),...r],this.trash=new Set,this.pathResolver=t.pathResolver}getModel(){if(!this.model){const e=this.hooks.resolveDataStages.call(this.baseMiddleware),t=new ue;t.setMiddleware(e),this.model=t}return this.model}resolveDataValue(e,t,r){return r?this.hooks.deformat.call(t,e):t}set(e,t){let r=[];r=Array.isArray(e)?e.map((([e,r])=>{const n=this.pathResolver.parse(e);return[n,this.resolveDataValue(n,r,Boolean(null==t?void 0:t.formatted))]})):Object.keys(e).map((r=>{const n=this.pathResolver.parse(r),i=e[r];return[n,this.resolveDataValue(n,i,Boolean(null==t?void 0:t.formatted))]}));const n=r.reduce(((e,[t,r])=>{var n,i;const o=this.get(t,{includeInvalid:!0}),s={binding:t,newValue:r,oldValue:o};return(0,p.J)(o,r)?null==(n=this.logger)||n.debug(`Skipping update for path: ${t.asString()}. Value was unchanged: ${o}`):(e.push(s),null==(i=this.logger)||i.debug(`Setting path: ${t.asString()} from: ${o} to: ${r}`)),e}),[]),i=this.getModel().set(r,t),o=new Set(n.map((e=>e.binding)));return i.forEach((e=>{var t;o.has(e.binding)||!0!==e.force&&(0,p.J)(e.oldValue,e.newValue)||(null==(t=this.logger)||t.debug(`Path: ${e.binding.asString()} was changed from: ${e.oldValue} to: ${e.newValue}`),n.push(e))})),this.hooks.onSet.call(r),n.length>0&&this.hooks.onUpdate.call(n,t),i}resolve(e,t){return Array.isArray(e)||"string"===typeof e?this.pathResolver.parse(e,{readOnly:t}):e}get(e,t){const r=e instanceof H?e:this.resolve(e,!0);let n=this.getModel().get(r,t);if(void 0===n&&!(null==t?void 0:t.ignoreDefaultValue)){const e=this.hooks.resolveDefaultValue.call(r);e!==n&&(n=e)}return(null==t?void 0:t.formatted)?n=this.hooks.format.call(n,r):!1===(null==t?void 0:t.formatted)&&(n=this.hooks.deformat.call(n,r)),this.hooks.onGet.call(e,n),n}delete(e,t){if("string"!==typeof e&&!Array.isArray(e)&&!(e instanceof H))throw new Error("Invalid arguments: delete expects a data path (string)");const r=e instanceof H?e:this.resolve(e,!1),n=r.parent(),i=r.key(),o=this.get(n),s="object"===typeof o&&null!==o&&Object.prototype.hasOwnProperty.call(o,i);this.getModel().delete(r,t),s&&!this.get(r)&&this.trash.add(r),this.hooks.onDelete.call(r)}serialize(){return this.hooks.serialize.call(this.get(""))}makeReadOnly(){return new gn(this,this.logger)}}var yn=Object.defineProperty,wn=Object.getOwnPropertySymbols,mn=Object.prototype.hasOwnProperty,bn=Object.prototype.propertyIsEnumerable,kn=(e,t,r)=>t in e?yn(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,Sn=(e,t)=>{for(var r in t||(t={}))mn.call(t,r)&&kn(e,r,t[r]);if(wn)for(var r of wn(t))bn.call(t,r)&&kn(e,r,t[r]);return e};function En(e,t=[],r="."){return Object.keys(e).reduce(((n,i)=>Sn(Sn({},n),"[object Object]"===Object.prototype.toString.call(e[i])?En(e[i],t.concat([i])):{[t.concat([i]).join(r)]:e[i]})),{})}function On(e){const t=En(e),r=[];return Object.keys(t).forEach((e=>{r.push([new H(e),t[e]])})),r}class Pn{constructor(){this.store=new Map,this.tempStore=new Map}addConstants(e,t){var r;this.store.has(t)?null==(r=this.store.get(t))||r.set(On(e)):this.store.set(t,new pe(e))}getConstants(e,t,r){var n,i,o,s;const a=new H(e);return null!=(s=null!=(o=null==(n=this.tempStore.get(t))?void 0:n.get(a))?o:null==(i=this.store.get(t))?void 0:i.get(a))?s:r}setTemporaryValues(e,t){var r;this.tempStore.has(t)?null==(r=this.tempStore.get(t))||r.set(On(e)):this.tempStore.set(t,new pe(e))}clearTemporaryValues(e){var t;e?null==(t=this.tempStore.get(e))||t.reset():this.tempStore.forEach((e=>{e.reset()}))}}class jn{constructor(){this.name="flow-exp-plugin"}apply(e){let t;const r=e=>{e&&("object"===typeof e&&"exp"in e?null==t||t.evaluate(e.exp):null==t||t.evaluate(e))};e.hooks.expressionEvaluator.tap(this.name,(e=>{t=e})),e.hooks.flowController.tap(this.name,(e=>{e.hooks.flow.tap(this.name,(e=>{e.hooks.onStart.tap(this.name,(e=>r(e))),e.hooks.onEnd.tap(this.name,(e=>r(e))),e.hooks.resolveTransitionNode.intercept({call:e=>{(null==e?void 0:e.onStart)&&r(e.onStart)}})}))}))}}class An{constructor(){this.name="flow-exp-plugin"}apply(e){let t;e.hooks.schema.tap(this.name,(e=>{var r;r=e,t=(e,t,n)=>{var i,o;return null!=(o=null==(i=r.getFormatterForType({type:n}))?void 0:i.format(t))?o:t}})),e.hooks.expressionEvaluator.tap(this.name,(r=>{t&&r.addExpressionFunction("format",t),r.addExpressionFunction("log",((t,...r)=>{e.logger.info(...r)})),r.addExpressionFunction("debug",((t,...r)=>{e.logger.debug(...r)})),r.addExpressionFunction("eval",((e,...t)=>e.evaluate(...t)))}))}}const Tn={ref:Symbol("not-started"),status:"not-started"};var Vn=Object.defineProperty,xn=Object.defineProperties,Cn=Object.getOwnPropertyDescriptors,Nn=Object.getOwnPropertySymbols,_n=Object.prototype.hasOwnProperty,Bn=Object.prototype.propertyIsEnumerable,Mn=(e,t,r)=>t in e?Vn(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,Rn=(e,t)=>{for(var r in t||(t={}))_n.call(t,r)&&Mn(e,r,t[r]);if(Nn)for(var r of Nn(t))Bn.call(t,r)&&Mn(e,r,t[r]);return e};const Dn=class{constructor(e){var t;this.logger=new et,this.constantsController=new Pn,this.state=Tn,this.hooks={flowController:new n.ni,viewController:new n.ni,view:new n.ni,expressionEvaluator:new n.ni,dataController:new n.ni,schema:new n.ni,validationController:new n.ni,bindingParser:new n.ni,state:new n.ni,onStart:new n.ni,onEnd:new n.ni,resolveFlowContent:new n.gg},(null==e?void 0:e.logger)&&this.logger.addHandler(e.logger),this.config=e||{},this.config.plugins=[new An,...this.config.plugins||[],new jn],null==(t=this.config.plugins)||t.forEach((e=>{e.apply(this)}))}getPlugins(){var e;return null!=(e=this.config.plugins)?e:[]}findPlugin(e){var t;return null==(t=this.config.plugins)?void 0:t.find((t=>t.symbol===e))}applyTo(e,t){const r=this.findPlugin(e);r&&t(r)}registerPlugin(e){var t;e.apply(this),null==(t=this.config.plugins)||t.push(e)}getVersion(){return Dn.info.version}getCommit(){return Dn.info.commit}getState(){return this.state}setState(e){this.state=e,this.hooks.state.call(e)}setupFlow(e){const t=this.hooks.resolveFlowContent.call(e),r=new Ur(t.navigation,{logger:this.logger});let n,i;this.hooks.onStart.call(t),this.hooks.flowController.call(r);const o=new oe({get:e=>i.get(e),set:e=>i.set(e),evaluate:e=>n.evaluate(e)});this.hooks.bindingParser.call(o);const s=o.parse,a=g()(),l=new dt(t.schema);this.hooks.schema.call(l);const c=new hn(l);let h;function d(e,t){return yt(e,{model:i,evaluate:n.evaluate,formatted:t})}var p,v;return this.hooks.validationController.call(c),i=new fn(t.data,{pathResolver:o,middleware:c.getDataMiddleware(),logger:this.logger}),i.hooks.format.tap("player",((e,t)=>{const r=l.getFormatter(t);return r?r.format(e):e})),i.hooks.deformat.tap("player",((e,t)=>{const r=l.getFormatter(t);return r?r.deformat(e):e})),i.hooks.resolveDefaultValue.tap("player",(e=>{var t;return null==(t=l.getApparentType(e))?void 0:t.default})),n=new Ze({model:i,logger:this.logger}),this.hooks.expressionEvaluator.call(n),n.hooks.onError.tap("player",(e=>(a.reject(e),!0))),r.hooks.flow.tap("player",(e=>{e.hooks.beforeTransition.tap("player",((e,t)=>{const r=e.transitions[t]?t:"*";return e.onEnd&&e.transitions[r]&&("object"===typeof e.onEnd&&"exp"in e.onEnd?null==n||n.evaluate(e.onEnd.exp):null==n||n.evaluate(e.onEnd)),"transitions"in e&&e.transitions[r]?(0,u.tP)(e,["transitions",r],d(e.transitions[r])):e})),e.hooks.skipTransition.tap("validation",(e=>{var t;if("VIEW"===(null==e?void 0:e.value.state_type)){const{canTransition:e,validations:r}=c.validateView("navigation");if(!e&&r){const e=new Set(r.keys());return null==(t=null==h?void 0:h.currentView)||t.update(e),!0}}})),e.hooks.resolveTransitionNode.tap("player",(e=>{let t=e;return"ref"in e&&(t=(0,u.tP)(e,["ref"],d(e.ref))),"param"in e&&(t=(0,u.tP)(e,["param"],d(e.param,!1))),t})),e.hooks.transition.tap("player",((e,t)=>{"VIEW"!==t.value.state_type&&c.reset()})),e.hooks.afterTransition.tap("player",(e=>{var t;const i=null==(t=e.currentState)?void 0:t.value;if(i&&"ACTION"===i.state_type){const{exp:e}=i;null==r||r.transition(String(null==n?void 0:n.evaluate(e)))}n.reset()}))})),this.hooks.dataController.call(i),c.setOptions({parseBinding:s,model:i,logger:this.logger,evaluate:n.evaluate,constants:this.constantsController}),h=new vn(t.views||[],{evaluator:n,parseBinding:s,transition:r.transition,model:i,utils:{findPlugin:e=>this.findPlugin(e)},logger:this.logger,flowController:r,schema:l,format:(e,t)=>{const r=l.getFormatter(e);return(null==r?void 0:r.format)?r.format(t):t},formatValue:(e,t)=>{const r=l.getFormatterForType(e);return(null==r?void 0:r.format)?r.format(t):t},validation:(p=Rn({},c.forView(s)),v={type:e=>l.getType(s(e))},xn(p,Cn(v))),constants:this.constantsController}),h.hooks.view.tap("player",(e=>{c.onView(e),this.hooks.view.call(e)})),this.hooks.viewController.call(h),{start:()=>{r.start().then((e=>({endState:d(e,!1),data:i.serialize()}))).then(a.resolve).catch((e=>{throw this.logger.error(`Something went wrong: ${e.message}`),e})).catch(a.reject).finally((()=>this.hooks.onEnd.call()))},state:{status:"in-progress",flowResult:a.promise,controllers:{data:i,view:h,flow:r,schema:l,expression:n,binding:o,validation:c},fail:a.reject,flow:t,logger:this.logger}}}start(e){return t=this,r=null,n=function*(){var t;const r=Symbol(null!=(t=null==e?void 0:e.id)?t:"payload"),n=e=>this.state.ref!==r?(this.logger.warn("Received update for a flow that's not the current one"),e):(this.setState(e),e);this.setState({status:"not-started",ref:r});try{const{state:t,start:i}=this.setupFlow(e);this.setState(Rn({ref:r},t)),i();const o={ref:r,status:"completed",flow:t.flow,controllers:{data:t.controllers.data.makeReadOnly()}};return n(Rn(Rn({},yield t.flowResult),o))}catch(i){throw n({status:"error",ref:r,flow:e,error:i}),i}},new Promise(((e,i)=>{var o=e=>{try{a(n.next(e))}catch(t){i(t)}},s=e=>{try{a(n.throw(e))}catch(t){i(t)}},a=t=>t.done?e(t.value):Promise.resolve(t.value).then(o,s);a((n=n.apply(t,r)).next())}));var t,r,n}};let In=Dn;In.info={version:"__VERSION__",commit:"__GIT_COMMIT__"}}}]);