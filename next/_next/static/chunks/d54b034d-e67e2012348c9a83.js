"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[6697],{89084:function(e,t,r){r.d(t,{oe:function(){return Je},J5:function(){return Dn},lH:function(){return vt}});var n=r(95311),o=r(25977),i=r.n(o),s=r(99488),a=r.n(s),l=r(78094),c=r.n(l),h=r(75944),p=r(27843),u=r.n(p),d=r(10643),v=r(89444),f=r(22876),g=r.n(f),y=r(65089),w=r.n(y),m=r(68230);const b=e=>({name:"Value",value:e}),S=e=>({name:"Expression",value:e}),k=e=>({name:"PathNode",path:e}),E=(e,t)=>({name:"Query",key:e,value:t}),O=e=>1===e.length?e[0]:{name:"Concatenated",value:e},P=c().string('"'),j=c().string("'"),T=c().string("`"),A=c().regex(/[\w\-@]+/).desc("identifier").map(b);let x;const C=c().lazy((()=>x)).trim(c().optWhitespace).wrap(c().string("{{"),c().string("}}")).map(k),V=c().regex(/[^`]*/).wrap(T,T).map(S),_=c().alt(A,C,V).atLeast(1).map(a()).map(O),N=c().alt(c().regex(/[^"]*/).wrap(P,P).map(b),c().regex(/[^']*/).wrap(j,j).map(b),_),B=c().seq(N,c().string("=").times(1,3).trim(c().optWhitespace),N).map((([e,,t])=>E(e,t))),R=c().alt(B,N).trim(c().optWhitespace).wrap(c().string("["),c().string("]")).many(),M=c().seqMap(_,R,((e,t)=>[e,...t]));x=c().sepBy(M,c().string(".")).map(a()),new h.Grammars.W3C.Parser('\nvalue                      ::= segment_and_bracket (SEGMENT_SEPARATOR segment_and_bracket)*\nsegment                    ::= concatenated | expression | modelRef | identifier  \nconcatenated               ::= (expression | modelRef | identifier)+ \nmodelRef                   ::= OPEN_CURL OPEN_CURL value CLOSE_CURL CLOSE_CURL \nidentifier                 ::= [\\w\\-@]+\nquery                      ::= WHITESPACE* optionally_quoted_segment WHITESPACE* EQUALS EQUALS? EQUALS? WHITESPACE* optionally_quoted_segment WHITESPACE*\nbrackets                   ::= OPEN_BRACKET WHITESPACE* (query | optionally_quoted_segment) WHITESPACE* CLOSE_BRACKET \nsegment_and_bracket        ::= segment brackets*\nquoted_value               ::= [^"\']*\noptionally_quoted_segment  ::= WHITESPACE* SINGLE_QUOTE quoted_value SINGLE_QUOTE WHITESPACE* | WHITESPACE* DOUBLE_QUOTE quoted_value DOUBLE_QUOTE WHITESPACE* | WHITESPACE* segment WHITESPACE*\nexpression_value           ::= [^`]*\nexpression                 ::= BACK_TICK expression_value BACK_TICK\n\nEQUALS                     ::= "="\nSEGMENT_SEPARATOR          ::= "."\nSINGLE_QUOTE               ::= "\'"\nDOUBLE_QUOTE               ::= \'"\'\nWHITESPACE                 ::= " "\nOPEN_CURL                  ::= "{"\nCLOSE_CURL                 ::= "}" \nOPEN_BRACKET               ::= "[" \nCLOSE_BRACKET              ::= "]"\nBACK_TICK                  ::= "`" \n');const D="{",U="'",I="`",$=e=>{if(!e)return!1;const t=e.charCodeAt(0);return t>=48&&t<=57||t>=65&&t<=90||t>=97&&t<=122||95===t||45===t||64===t},F=e=>{let t=1,r=e.charAt(0);const n=n=>{if(n&&r!==n)throw new Error(`Expected char: ${n} but got: ${r}`);return r=e.charAt(t),t+=1,r},o=()=>{for(;" "===r;)n()},i=()=>{var e,t;return null!=(t=null!=(e=(()=>{if(r===D&&(n(D),r===D)){n(D);const e=c();return n("}"),n("}"),e}})())?e:(()=>{if(r===I){n(I);let e=r;for(;n()&&r!==I;)e+=r;if(n(I),e)return S(e)}})())?t:(()=>{if(!$(r))return;let e=r;for(;n()&&$(r);)e+=r;return e?b(e):void 0})()},s=()=>{if(o(),r===U||'"'===r){const e=r===U;n(e?U:'"');const t=(e=>{if(!(null==r?void 0:r.match(e)))return;let t=r;for(;n()&&(null==r?void 0:r.match(e));)t+=r;return t?b(t):void 0})(/[^'"]+/);return n(e?U:'"'),t}return i()},a=()=>{if("["===r){n("["),o();let e=s();if(!e)throw new Error("Expected identifier");if(o(),(()=>{if("="!==r)return!1;for(;"="===r;)n();return!0})()){o();const t=s();e=E(e,t),o()}return e&&n("]"),e}},l=()=>{const e=[],t=(()=>{const e=[];let t=i();for(;void 0!==t;)e.push(t),t=i();if(0!==e.length)return O(e)})();if(t){e.push(t);let r=a();for(;void 0!==r;)e.push(r),r=a()}return e},c=()=>{const e=[];let t=l();for(;void 0!==t&&(e.push(...t),r&&"}"!==r);){if(0===t.length&&r)throw new Error(`Unexpected character: ${r}`);n("."),t=l()}return k(e)};try{return{status:!0,path:c()}}catch(h){return{status:!1,error:h.message}}};function H(e){return!("string"===typeof e||Array.isArray(e))}class z{constructor(e,t=(e=>new z(e))){const r=Array.isArray(e)?e:e.split(".");this.split=r.map((e=>{if("number"===typeof e)return e;const t=Number(e);return isNaN(t)?e:t})),Object.freeze(this.split),this.joined=this.split.join("."),this.factory=t}asArray(){return this.split}asString(){return this.joined}contains(e){const t=e.asArray();if(t.length<this.split.length)return!1;for(let r=0;r<this.split.length;r++)if(this.split[r]!==t[r])return!1;return!0}relative(e){return this.asArray().slice(e.asArray().length)}parent(){return this.factory(this.split.slice(0,-1))}key(){return this.split[this.split.length-1]}descendent(e){const t=(r=e,Array.isArray(r)?r:"string"===typeof r?r.split("."):r.asArray());var r;return this.factory(this.split.concat(t))}}var L=Object.defineProperty,W=Object.getOwnPropertySymbols,q=Object.prototype.hasOwnProperty,G=Object.prototype.propertyIsEnumerable,K=(e,t,r)=>t in e?L(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,Q=(e,t)=>{for(var r in t||(t={}))q.call(t,r)&&K(e,r,t[r]);if(W)for(var r of W(t))G.call(t,r)&&K(e,r,t[r]);return e};function J(e,t,r){var n;const o={updates:{},path:[]};function s(e){if("Value"===e.name)return e.value;if("PathNode"===e.name){const n=J(e,t);n.updates&&(o.updates=Q(Q({},o.updates),n.updates));try{return t.convertToPath(t.getValue(n.path))}catch(r){throw new(i())(`Unable to resolve path segment: ${n.path}`,r)}}if("Expression"===e.name)try{const r=t.evaluate(e.value);return t.convertToPath(r)}catch(r){throw new(i())(`Unable to resolve path: ${e.value}`,r)}throw new Error(`Unable to resolve value for node: ${e.name}`)}function a(e){"string"===typeof e&&e.indexOf(".")>-1?e.split(".").forEach((e=>{o.path.push(function(e){const t=parseInt(e,10);return isNaN(t)?e:t}(e))})):o.path.push(e)}return e.path.forEach((function(e){var n,i;const l=null!=(n=null==r?void 0:r.beforeResolveNode.call(e,Q(Q({},o),t)))?n:e;switch(l.name){case"Expression":case"PathNode":a(s(l));break;case"Value":a(l.value);break;case"Query":{const e=null!=(i=t.getValue(o.path))?i:[],{key:r,value:n}=l,a=s(r),c=n&&s(n),h=function(e,t,r){return e.findIndex((e=>!(!e||"object"!==typeof e)&&e[t]==r))}(e,a,c);void 0===h||-1===h?(o.updates[[...o.path,e.length,a].join(".")]=c,o.path.push(e.length)):o.path.push(h);break}case"Concatenated":o.path.push(l.value.map(s).join(""));break;default:throw new Error(`Unsupported node type: ${l.name}`)}})),{path:o.path,updates:Object.keys(null!=(n=o.updates)?n:{}).length>0?o.updates:void 0}}var Z=Object.defineProperty,X=Object.getOwnPropertySymbols,Y=Object.prototype.hasOwnProperty,ee=Object.prototype.propertyIsEnumerable,te=(e,t,r)=>t in e?Z(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,re=(e,t)=>{for(var r in t||(t={}))Y.call(t,r)&&te(e,r,t[r]);if(X)for(var r of X(t))ee.call(t,r)&&te(e,r,t[r]);return e};const ne=/^[\w\-@]+(\.[\w\-@]+)*$/,oe={get:()=>{throw new Error("Not Implemented")},set:()=>{throw new Error("Not Implemented")},evaluate:()=>{throw new Error("Not Implemented")}};class ie{constructor(e){this.hooks={skipOptimization:new n.oI,beforeResolveNode:new n.gg},this.parserOptions=re(re({},oe),e),this.cache={},this.parseCache={},this.parse=this.parse.bind(this)}normalizePath(e,t){var r,n;if(e.match(ne)&&!0!==this.hooks.skipOptimization.call(e))return{path:e.split("."),updates:void 0};const o=null!=(r=this.parseCache[e])?r:F(e);if(this.parseCache[e]=o,"object"!==typeof o||!(null==o?void 0:o.status))throw new TypeError(`Cannot normalize path "${e}": ${null!=(n=null==o?void 0:o.error)?n:"Unknown Error."}`);try{return J(o.path,t,this.hooks)}catch(s){throw new(i())(`Cannot resolve binding: ${e}`,s)}}getBindingForNormalizedResult(e){const t=e.path.join(".");if(this.cache[t])return this.cache[t];const r=new z(""===t?[]:e.path,this.parse);return this.cache[t]=r,r}parse(e,t={}){if(H(e))return e;const r=re(re({},this.parserOptions),t);let n={};const o=Array.isArray(e)?e.join("."):String(e),i={getValue:e=>{const t=this.normalizePath(e.join("."),i);return r.get(this.getBindingForNormalizedResult(t))},evaluate:e=>r.evaluate(e),convertToPath:e=>{if(void 0===e)throw new Error("Attempted to convert undefined value to binding path");if("string"!==typeof e&&"number"!==typeof e&&"boolean"!==typeof e)throw new Error(`Attempting to convert ${typeof e} to a binding path.`);const t=this.normalizePath(String(e),i);t.updates&&(n=re(re({},n),t.updates));const r=t.path.join(".");if(""===r)throw new Error("Nested path resolved to an empty path");return r}},s=this.normalizePath(o,i);s.updates&&(n=re(re({},n),s.updates));const a=Object.keys(n);if(a.length>0){const e=a.map((e=>[this.parse(e),n[e]]));r.set(e)}return this.getBindingForNormalizedResult(s)}}class se{constructor(){this.readDeps=new Set,this.writeDeps=new Set,this.namedDependencySets={},this.namedSet="core",this.createSubset("core"),this.createSubset("children")}createSubset(e,t=!1){!t&&this.namedDependencySets[e]||(this.namedDependencySets[e]={readDeps:new Set,writeDeps:new Set})}getDependencies(e){var t,r,n;return void 0!==e?null!=(n=null==(r=null==(t=this.namedDependencySets)?void 0:t[e])?void 0:r.readDeps)?n:new Set:this.readDeps}trackSubset(e){this.createSubset(e),this.namedSet=e}trackDefault(){this.namedSet="core"}getModified(e){var t,r,n;return void 0!==e?null!=(n=null==(r=null==(t=this.namedDependencySets)?void 0:t[e])?void 0:r.writeDeps)?n:new Set:this.writeDeps}readsBinding(e){return this.readDeps.has(e)}writesBinding(e){return this.writeDeps.has(e)}reset(){this.readDeps=new Set,this.writeDeps=new Set,this.namedDependencySets={},this.namedSet="core",this.createSubset("core",!0),this.createSubset("children",!0)}addReadDep(e,t=this.namedSet){var r,n;t&&(null==(n=null==(r=this.namedDependencySets)?void 0:r[t])||n.readDeps.add(e)),this.readDeps.add(e)}addWriteDep(e,t=this.namedSet){var r,n;t&&(null==(n=null==(r=this.namedDependencySets)?void 0:r[t])||n.writeDeps.add(e)),this.writeDeps.add(e)}addChildReadDep(e){this.addReadDep(e,"children")}}class ae extends se{constructor(e){super(),this.rootModel=e,this.set=this.set.bind(this),this.get=this.get.bind(this)}set(e,t){return e.forEach((([e])=>this.addWriteDep(e))),this.rootModel.set(e,t)}get(e,t){return this.addReadDep(e),this.rootModel.get(e,t)}}const le=new class{get(){}set(){return[]}},ce=new z([]);function he(e,t,r){return r?{get:(n,o)=>e.get(n,null!=o?o:t,r),set:(n,o)=>e.set(n,null!=o?o:t,r)}:e}function pe(e){if(0===e.length)return le;if(1===e.length)return e[0];function t(t){var r;return null!=(r=e.reduce(((e,r)=>he(r,t,e)),void 0))?r:le}return{get:(e,r)=>{var n;return null==(n=t(r))?void 0:n.get(e,r)},set:(e,r)=>{var n;return null==(n=t(r))?void 0:n.set(e,r)}}}class ue{constructor(e=[]){this.hooks={onSet:new n.ni},this.pipeline=e,this.effectiveDataModel=pe(this.pipeline)}setMiddleware(e){this.pipeline=e,this.effectiveDataModel=pe(e)}addMiddleware(e){this.pipeline=[...this.pipeline,e],this.effectiveDataModel=pe(this.pipeline)}reset(e={}){this.pipeline.forEach((e=>{var t;"reset"in e&&(null==(t=e.reset)||t.call(e))})),this.set([[ce,e]])}set(e,t){const r=this.effectiveDataModel.set(e,t);return this.hooks.onSet.call(e),r}get(e,t){return this.effectiveDataModel.get(e,t)}}class de{constructor(e={}){this.model=e,this.get=this.get.bind(this),this.set=this.set.bind(this)}reset(e={}){this.model=e}get(e){return e&&e.asString()?u()(this.model,e.asArray()):this.model}set(e){const t=[];return e.forEach((([e,r])=>{const n=this.get(e);this.model=(0,d.tP)(this.model,e.asArray(),r),t.push({binding:e,oldValue:n,newValue:r})})),t}}const ve=Symbol("Expression Node ID");const fe=46,ge=40,ye=123,we=125,me=!0,be={"-":me,"!":me,"~":me,"+":me},Se={"=":3,"+=":3,"-=":3,"&=":3,"|=":3,"||":5,"&&":6,"|":7,"^":8,"&":9,"==":10,"!=":10,"===":10,"!==":10,"<":11,">":11,"<=":11,">=":11,"<<":12,">>":12,">>>":12,"+":13,"-":13,"*":14,"/":14,"%":14};function ke(e,t){const r=new Error(`${e} at character ${t}`);throw r.index=t,r.description=e,r}function Ee(e,t){if(e&&t)return{start:e.start,end:t.end}}function Oe(e){let t=0;return Object.keys(e).forEach((r=>{r.length>t&&Object.prototype.hasOwnProperty.call(e,r)&&(t=r.length)})),t}const Pe=Oe(be),je=Oe(Se),Te={true:!0,false:!1,null:null,undefined:void 0};function Ae(e){return Se[e]||0}function xe(e,t,r,n){let o;return o="||"===e||"&&"===e?"LogicalExpression":"="===e?"Assignment":"+="===e||"-="===e||"&="===e||"|="===e?"Modification":"BinaryExpression",{__id:ve,type:o,operator:e,left:t,right:r,location:n}}function Ce(e){return e>=48&&e<=57}function Ve(e){return 36===e||95===e||e>=65&&e<=90||e>=97&&e<=122}function _e(e){return 36===e||95===e||e>=65&&e<=90||e>=97&&e<=122||e>=48&&e<=57}function Ne(e,t){var r;const n=null==(r=null==t?void 0:t.strict)||r,o=e.charAt,i=e.charCodeAt,{length:s}=e;let a=0;const l=e=>({start:{character:e},end:{character:a}});function c(t){return o.call(e,t)}function h(t){return i.call(e,t)}function p(){let e=h(a);for(;32===e||9===e;)e=h(++a)}function u(){const e=function(){let e,t,r,n=v(),o=d();if(!o)return n;let i={value:o,prec:Ae(o)},s=v();s||ke(`Expected expression after ${o}`,a);const l=[n,i,s];o=d();for(;o&&(t=Ae(o),0!==t);){for(i={value:o,prec:t};l.length>2&&t<=l[l.length-2].prec;)s=l.pop(),o=l.pop().value,n=l.pop(),e=xe(o,n,s,Ee(n.location,s.location)),l.push(e);e=v(),e||ke(`Expected expression after ${o}`,a),l.push(i,e),o=d()}r=l.length-1,e=l[r];for(;r>1;)e=xe(l[r-1].value,l[r-2],e,Ee(l[r-2].location,e.location)),r-=2;return e}();p();const t=a;if(a<s&&63===h(a)){a++;const r=u();if(r||ke("Expected expression",a),p(),58===h(a)){a++;const n=u();return n||ke("Expected expression",a),{__id:ve,type:"ConditionalExpression",test:e,consequent:r,alternate:n,location:l(t)}}ke("Expected :",a)}return e}function d(){p();let t=e.substr(a,je),r=t.length;for(;r>0;){if(Object.prototype.hasOwnProperty.call(Se,t))return a+=r,t;t=t.substr(0,--r)}return!1}function v(){p();const t=h(a),r=a;if(Ce(t)||46===t)return function(){let e="";const t=a;for(;Ce(h(a));)e+=c(a++);if(h(a)===fe)for(e+=c(a++);Ce(h(a));)e+=c(a++);let r=c(a);if("e"===r||"E"===r){for(e+=c(a++),r=c(a),"+"!==r&&"-"!==r||(e+=c(a++));Ce(h(a));)e+=c(a++);Ce(h(a-1))||ke(`Expected exponent (${e}${c(a)})`,a)}const n=h(a);Ve(n)?ke(`Variable names cannot start with a number (${e}${c(a)})`,a):n===fe&&ke("Unexpected period",a);return{__id:ve,type:"Literal",value:parseFloat(e),raw:e,location:l(t)}}();if(39===t||34===t)return f();if(Ve(t)||40===t)return function(){let e=h(a),t=e===ge?function(){a++;const e=u();if(p(),41===h(a))return a++,e;ke("Unclosed (",a)}():g();const r=a;p(),e=h(a);for(;e===fe||91===e||e===ge;)a++,e===fe?(p(),t={__id:ve,type:"MemberExpression",computed:!1,object:t,property:g(),location:l(r)}):91===e?(t={__id:ve,type:"MemberExpression",computed:!0,object:t,property:u(),location:l(r)},p(),e=h(a),93!==e&&ke("Unclosed [",a),a++):e===ge&&(t={__id:ve,type:"CallExpression",args:y(41),callTarget:t,location:l(r)}),p(),e=h(a);return t}();if(91===t)return function(){const e=a;return a++,{__id:ve,type:"ArrayExpression",elements:y(93),location:l(e)}}();if(n=t,o=h(a+1),n===ye&&o===ye)return function(){let e="",t=!1,r=1;const n=a;a+=2;for(;a<s;){const n=c(a++);if("}"===n&&h(a)===we){if(a++,r--,0===r){t=!0;break}e+="}}"}else"{"===n&&h(a)===ye?(r++,e+="{{",a++):e+=n}t||ke(`Unclosed brace after "${e}"`,a);return{__id:ve,type:"ModelRef",ref:e,location:l(n)}}();var n,o;if(t===ye)return function(){const e=[];let t,r,n,o=!1,i=!0;const c=a;for(++a;a<s;){if(p(),n=h(a),125===n){t&&ke("A key was defined but a value was not",a),a++,o=!0;break}i?(39!==n&&34!==n&&ke("An object must start wtih a key",a),t=f(),p(),58===h(a)?(a++,i=!1):ke("A colon must follow an object key",a)):(r=u(),e.push({key:t,value:r}),p(),n=h(a),44===n?a++:125!==n&&ke("Please add a comma to add another key",a),i=!0,t=void 0,r=void 0),n=h(a)}return o||ke("Unclosed brace in object",a),{__id:ve,type:"Object",attributes:e,location:l(c)}}();let i=e.substr(a,Pe),d=i.length;for(;d>0;){if(Object.prototype.hasOwnProperty.call(be,i))return a+=d,{__id:ve,type:"UnaryExpression",operator:i,argument:v(),prefix:!0,location:l(r)};i=i.substr(0,--d)}return!1}function f(){const e=c(a++);let t="",r=!1;const n=a;for(;a<s;){let n=c(a++);if(n===e){r=!0;break}if("\\"===n)switch(n=c(a++),n){case"n":t+="\n";break;case"r":t+="\r";break;case"t":t+="\t";break;case"b":t+="\b";break;case"f":t+="\f";break;case"v":t+="\v"}else t+=n}return r||ke(`Unclosed quote after "${t}"`,a),{__id:ve,type:"Literal",value:t,raw:`${e}${t}${e}`,location:l(n)}}function g(){const t=a;let r=h(t);for(Ve(r)?a++:ke(`Unexpected ${c(a)}`,a);a<s&&(r=h(a),_e(r));)a++;const n=e.slice(t,a);return Object.prototype.hasOwnProperty.call(Te,n)?{__id:ve,type:"Literal",value:Te[n],raw:n,location:l(t)}:"this"===n?{__id:ve,type:"ThisExpression",location:l(t)}:{__id:ve,type:"Identifier",name:n,location:l(t)}}function y(e){const t=[];let r,n;for(;a<s;){if(p(),r=h(a),r===e){a++;break}44!==r?(n=u(),n&&"Compound"!==n.type||ke("Expected comma",a),t.push(n)):a++}return r!==e&&ke(`Expected ${String.fromCharCode(e)}`,a),t}const w=[];try{for(;a<s;){const e=h(a);if(59===e||44===e){a++;continue}const t=u();t?w.push(t):a<s&&ke(`Unexpected "${c(a)}"`,a)}return 1===w.length?w[0]:{__id:ve,type:"Compound",body:w,location:l(0)}}catch(m){if(n||!(m instanceof Error))throw m;return{__id:ve,type:"Compound",body:w,location:l(0),error:m}}}var Be=Object.freeze({__proto__:null,setDataVal:(e,t,r)=>{e.model.set([[t,r]])},getDataVal:(e,t)=>e.model.get(t),deleteDataVal:(e,t)=>e.model.set([[t,void 0]])}),Re=Object.defineProperty,Me=Object.defineProperties,De=Object.getOwnPropertyDescriptors,Ue=Object.getOwnPropertySymbols,Ie=Object.prototype.hasOwnProperty,$e=Object.prototype.propertyIsEnumerable,Fe=(e,t,r)=>t in e?Re(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,He=(e,t)=>{for(var r in t||(t={}))Ie.call(t,r)&&Fe(e,r,t[r]);if(Ue)for(var r of Ue(t))$e.call(t,r)&&Fe(e,r,t[r]);return e},ze=(e,t)=>Me(e,De(t));const Le=(e,t,r)=>e.evaluate(t)&&e.evaluate(r);Le.resolveParams=!1;const We=(e,t,r)=>e.evaluate(t)||e.evaluate(r);We.resolveParams=!1;const qe={"+":(e,t)=>e+t,"-":(e,t)=>e-t,"*":(e,t)=>e*t,"/":(e,t)=>e/t,"%":(e,t)=>e%t,"==":(e,t)=>e==t,"!=":(e,t)=>e!=t,">":(e,t)=>e>t,">=":(e,t)=>e>=t,"<":(e,t)=>e<t,"<=":(e,t)=>e<=t,"&&":Le,"||":We,"!==":(e,t)=>e!==t,"===":(e,t)=>e===t,"|":(e,t)=>e|t,"&":(e,t)=>e&t,"+=":(e,t)=>e+t,"-=":(e,t)=>e-t,"&=":(e,t)=>e&t,"|=":(e,t)=>e|t},Ge={"-":e=>-e,"+":e=>Number(e),"!":e=>!e};class Ke{constructor(e){this.vars={},this.hooks={resolve:new n.gg,onError:new n.oI},this.expressionsCache=new Map,this.operators={binary:new Map(Object.entries(qe)),unary:new Map(Object.entries(Ge)),expressions:new Map(Object.entries(Be))},this.defaultHookOptions=ze(He({},e),{evaluate:e=>this.evaluate(e,this.defaultHookOptions),resolveNode:e=>this._execAST(e,this.defaultHookOptions)}),this.hooks.resolve.tap("ExpressionEvaluator",this._resolveNode.bind(this)),this.evaluate=this.evaluate.bind(this)}reset(){this.expressionsCache.clear()}evaluate(e,t){const r=ze(He(He({},this.defaultHookOptions),t),{resolveNode:e=>this._execAST(e,r)});if("number"===typeof e||"boolean"===typeof e||void 0===e||null===e)return e;if("object"===typeof(n=e)&&n.__id===ve)return this._execAST(e,r);var n;if("object"===typeof e){return(Array.isArray(e)?e:Object.values(e)).reduce(((e,r)=>this.evaluate(r,t)),null)}return this._execString(String(e),r)}addExpressionFunction(e,t){this.operators.expressions.set(e,t)}addBinaryOperator(e,t){this.operators.binary.set(e,t)}addUnaryOperator(e,t){this.operators.unary.set(e,t)}setExpressionVariable(e,t){this.vars[e]=t}getExpressionVariable(e){return this.vars[e]}_execAST(e,t){return this.hooks.resolve.call(void 0,e,t)}_execString(e,t){if(""===e)return e;const r=e.match(/^@\[(.*)\]@$/);let n=e;r&&([,n]=Array.from(r));try{const e=this.expressionsCache.get(n);if(e)return this._execAST(e,t);const r=Ne(n);return this.expressionsCache.set(n,r),this._execAST(r,t)}catch(o){if(!this.hooks.onError.call(o))throw o}}_resolveNode(e,t,r){const{resolveNode:n,model:o}=r,i=ze(He({},r),{evaluate:e=>this.evaluate(e,r)});if("Literal"===t.type)return t.value;if("Identifier"===t.type)return this.vars[t.name];if("Compound"===t.type||"ThisExpression"===t.type)throw new Error(`Expression type: ${t.type} is not supported`);if("BinaryExpression"===t.type||"LogicalExpression"===t.type){const e=this.operators.binary.get(t.operator);return e?"resolveParams"in e?!1===e.resolveParams?e(i,t.left,t.right):e(i,n(t.left),n(t.right)):e(n(t.left),n(t.right)):void 0}if("UnaryExpression"===t.type){const e=this.operators.unary.get(t.operator);return e?"resolveParams"in e?e(i,!1===e.resolveParams?t.argument:n(t.argument)):e(n(t.argument)):void 0}if("Object"===t.type){const{attributes:e}=t,r={};return e.forEach((e=>{const t=n(e.key),o=n(e.value);r[t]=o})),r}if("CallExpression"===t.type){const e=t.callTarget.name;if("conditional"===e){return n(t.args[0])?n(t.args[1]):t.args[2]?n(t.args[2]):null}const r=this.operators.expressions.get(e);if(!r)throw new Error(`Unknown expression function: ${e}`);return r(i,...t.args.map((e=>n(e))))}if("ModelRef"===t.type)return o.get(t.ref);if("MemberExpression"===t.type){return n(t.object)[n(t.property)]}if("Assignment"!==t.type){if("ConditionalExpression"===t.type){const e=n(t.test)?t.consequent:t.alternate;return n(e)}if("ArrayExpression"===t.type)return t.elements.map((e=>n(e)));if("Modification"===t.type){const e=this.operators.binary.get(t.operator);if(e){let r;return r="resolveParams"in e?!1===e.resolveParams?e(i,t.left,t.right):e(i,n(t.left),n(t.right)):e(n(t.left),n(t.right)),"ModelRef"===t.left.type?o.set([[t.left.ref,r]]):"Identifier"===t.left.type&&(this.vars[t.left.name]=r),r}return n(t.left)}}else{if("ModelRef"===t.left.type){const e=n(t.right);return o.set([[t.left.ref,e]]),e}if("Identifier"===t.left.type){const e=n(t.right);return this.vars[t.left.name]=e,e}}}}const Qe=()=>{};class Je{constructor(){this.trace=Qe,this.debug=Qe,this.info=Qe,this.warn=Qe,this.error=Qe}}class Ze{constructor(){this.hooks={trace:new n.ni,debug:new n.ni,info:new n.ni,warn:new n.ni,error:new n.ni,log:new n.ni},this.logHandlers=new Set,this.trace=this.createHandler("trace"),this.debug=this.createHandler("debug"),this.info=this.createHandler("info"),this.warn=this.createHandler("warn"),this.error=this.createHandler("error")}createHandler(e){return(...t)=>{this.hooks[e].call(t),this.hooks.log.call(e,t),this.logHandlers.forEach((r=>r[e](...t)))}}addHandler(e){this.logHandlers.add(e)}removeHandler(e){this.logHandlers.delete(e)}}class Xe{constructor(e){this.trace=this.createHandler("trace"),this.debug=this.createHandler("debug"),this.info=this.createHandler("info"),this.warn=this.createHandler("warn"),this.error=this.createHandler("error"),this.proxiedLoggerProvider=e}createHandler(e){return(...t)=>{const r=this.proxiedLoggerProvider();null==r||r[e](...t)}}}var Ye=Object.defineProperty,et=Object.defineProperties,tt=Object.getOwnPropertyDescriptors,rt=Object.getOwnPropertySymbols,nt=Object.prototype.hasOwnProperty,ot=Object.prototype.propertyIsEnumerable,it=(e,t,r)=>t in e?Ye(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,st=(e,t)=>{for(var r in t||(t={}))nt.call(t,r)&&it(e,r,t[r]);if(rt)for(var r of rt(t))ot.call(t,r)&&it(e,r,t[r]);return e};const at=e=>e;class lt{constructor(e){this.formatters=new Map,this.types=new Map,this.schema=new Map,this.bindingSchemaNormalizedCache=new Map,this.hooks={resolveTypeForBinding:new n.gg},this.schema=e?function(e){const t=new Map;if(!e.ROOT)return t;const r=[{node:e.ROOT,path:[],visited:new Set}];for(;r.length>0;){const n=r.shift();if(!n)break;const{node:o,path:i,visited:s}=n;Object.entries(o).forEach((([n,o])=>{const a=[...i,n],l=a.join(".");if(t.has(l))throw new Error("Path has already been processed. There's either a loop somewhere or a bug");if(s.has(o.type))throw new Error(`Path already contained type: ${o.type}. This likely indicates a loop in the schema`);t.set(l,o),o.isArray&&a.push("[]"),o.isRecord&&a.push("{}"),o.type&&e[o.type]&&r.push({path:a,node:e[o.type],visited:new Set([...s,o.type])})}))}return t}(e):new Map}addFormatters(e){e.forEach((e=>{this.formatters.set(e.name,e)}))}addDataTypes(e){e.forEach((e=>{this.types.set(e.type,e)}))}getValidationsForBinding(e){var t;const r=this.getApparentType(e);if(null==(t=null==r?void 0:r.validation)?void 0:t.length)return r.validation.map((e=>st({severity:"error",trigger:"change"},e)))}normalizeBinding(e){const t=this.bindingSchemaNormalizedCache.get(e);if(t)return t;let r=e.asArray(),n=r.map((e=>"number"===typeof e?"[]":e)).join(".");return n&&(this.bindingSchemaNormalizedCache.set(e,n),r=n.split(".")),r.forEach((t=>{const o=r.map((e=>e===t?"{}":e)).join(".");this.schema.get(o)&&(this.bindingSchemaNormalizedCache.set(e,o),r=o.split("."),n=o)})),n}getType(e){return this.hooks.resolveTypeForBinding.call(this.schema.get(this.normalizeBinding(e)),e)}getApparentType(e){var t,r;const n=this.getType(e);if(void 0===n)return;const o=this.getTypeDefinition(null==n?void 0:n.type);return void 0===o?n:(i=st(st({},o),n),s={validation:[...null!=(t=n.validation)?t:[],...null!=(r=o.validation)?r:[]]},et(i,tt(s)));var i,s}getTypeDefinition(e){return this.types.get(e)}getFormatterForType(e){const t=e,{type:r}=t,n=((e,t)=>{var r={};for(var n in e)nt.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&rt)for(var n of rt(e))t.indexOf(n)<0&&ot.call(e,n)&&(r[n]=e[n]);return r})(t,["type"]),o=this.formatters.get(r);if(o)return{format:o.format?e=>{var t;return null==(t=o.format)?void 0:t.call(o,e,n)}:at,deformat:o.deformat?e=>{var t;return null==(t=o.deformat)?void 0:t.call(o,e,n)}:at}}getFormatter(e){const t=this.getApparentType(e);if(null==t?void 0:t.format)return this.getFormatterForType(t.format)}}const ct="{{",ht="}}";function pt(e){const t=e.indexOf(ct);if(-1===t)return;let r=1,n=t+ct.length,o=e.substring(t+ct.length);for(;r>0&&o.length>0;){const e=o.indexOf(ht);if(-1===e)break;const t=o.indexOf(ct);-1!==t&&t<e?(r++,o=o.substring(t+ct.length),n+=t+ct.length):(r--,o=o.substring(e+ht.length),n+=e+ht.length)}if(0!==r)throw new Error(`Unbalanced {{ and }} in exp: ${e}`);return{start:t,end:n}}function ut(e,t){const{model:r}=t;let n=function(e,{evaluate:t}){if(!t)return e;const r=/@\[.*?\]@/;let n=e,o=n.match(r);for(;null!==o;){const i=o[0],s=n.indexOf(i),a=t(i.substr("@[".length,i.length-"@[".length-"]@".length));if(0===s&&i===e&&"string"!==typeof a)return a;n=n.substr(0,s)+a+n.substr(s+i.length),o=n.match(r)}return n}(e,t);if(!r||"string"!==typeof n||-1===n.indexOf(ct))return n;for(;-1!==n.indexOf(ct);){const e=pt(n);if(!e)return n;const{start:t,end:o}=e,i=n.substring(t+ct.length,o-ct.length).trim(),s=r.get(i,{formatted:!0});if(0===t&&o===n.length&&"string"!==typeof s)return s;n=n.substr(0,t)+s+n.substr(o)}return n}function dt(e,t){switch(typeof e){case"string":return ut(e,t);case"object":{if(!e)return e;const r=Object.keys(e);let n=e;return r.length>0&&r.forEach((r=>{n=(0,d.tP)(n,[r],dt(e[r],t))})),n}default:return e}}function vt(e,t){return dt(e,t)}var ft,gt,yt=Object.defineProperty,wt=Object.defineProperties,mt=Object.getOwnPropertyDescriptors,bt=Object.getOwnPropertySymbols,St=Object.prototype.hasOwnProperty,kt=Object.prototype.propertyIsEnumerable,Et=(e,t,r)=>t in e?yt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;class Ot{constructor(e,t){this.validator=e,this.shadowModelPaths=new Map,this.logger=null==t?void 0:t.logger}set(e,t,r){const n=he(this,(o=((e,t)=>{for(var r in t||(t={}))St.call(t,r)&&Et(e,r,t[r]);if(bt)for(var r of bt(t))kt.call(t,r)&&Et(e,r,t[r]);return e})({},t),wt(o,mt({includeInvalid:!0}))),r);var o;const i=[];e.forEach((([e,t])=>{this.shadowModelPaths.set(e,t)}));const s=[];if(this.shadowModelPaths.forEach(((e,t)=>{var r;const o=this.validator(t,n);void 0===o?i.push([t,e]):o instanceof Set?o.forEach((r=>{s.push(r.binding),r.isStrong||r.binding.asString()!==t.asString()||i.push([r.binding,e])})):null==(r=this.logger)||r.debug(`Invalid value for path: ${t.asString()} - ${o.severity} - ${o.message}`)})),r&&i.length>0){i.forEach((([e])=>this.shadowModelPaths.delete(e)));const e=r.set(i,t);if(0===s.length)return e}return s.map((e=>({binding:e,oldValue:n.get(e),newValue:n.get(e),force:!0})))}get(e,t,r){let n=null==r?void 0:r.get(e,t);return!0===(null==t?void 0:t.includeInvalid)&&this.shadowModelPaths.forEach(((t,r)=>{r!==e?e.contains(r)&&(n=(0,d.tP)(n,r.relative(e),t)):n=t})),n}}class Pt{constructor(){this.registry=new Map}get(e){return this.registry.get(e)}register(e,t){this.registry.set(e,t)}}(gt=ft||(ft={})).Asset="asset",gt.View="view",gt.Applicability="applicability",gt.Template="template",gt.Value="value",gt.MultiNode="multi-node",gt.Switch="switch",gt.Unknown="unknown",gt.Empty="empty";var jt=Object.defineProperty,Tt=Object.defineProperties,At=Object.getOwnPropertyDescriptors,xt=Object.getOwnPropertySymbols,Ct=Object.prototype.hasOwnProperty,Vt=Object.prototype.propertyIsEnumerable,_t=(e,t,r)=>t in e?jt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,Nt=(e,t)=>{for(var r in t||(t={}))Ct.call(t,r)&&_t(e,r,t[r]);if(xt)for(var r of xt(t))Vt.call(t,r)&&_t(e,r,t[r]);return e},Bt=(e,t)=>Tt(e,At(t));const Rt={type:ft.Empty};class Mt{constructor(){this.hooks={onParseObject:new n.gg,onCreateASTNode:new n.gg,determineNodeType:new n.oI,parseNode:new n.oI}}parseView(e){const t=this.parseObject(e,ft.View);if(!t)throw new Error("Unable to parse object into a view");return t}createASTNode(e,t){const r=this.hooks.onCreateASTNode.call(e,t);return void 0===r?e:r}parseObject(e,t=ft.Value,r={templateDepth:0}){var n;const o=this.hooks.determineNodeType.call(e);if(void 0!==o){const n=this.hooks.parseNode.call(e,t,r,o);if(n)return n}const i=(e,n,o=[])=>{if("object"!==typeof n||null===n)return{value:n,children:[]};const s=this.hooks.onParseObject.call(n,t);if(!s)return e;const a={children:[],value:e};return(Array.isArray(s)?s.map(((e,t)=>[t,e])):[...Object.entries(s),...Object.getOwnPropertySymbols(s).map((e=>[e,s[e]]))]).reduce(((e,n)=>{const s=e,{children:a}=s,l=((e,t)=>{var r={};for(var n in e)Ct.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&xt)for(var n of xt(e))t.indexOf(n)<0&&Vt.call(e,n)&&(r[n]=e[n]);return r})(s,["children"]),[c,h]=n;if("asset"===c&&"object"===typeof h){const e=this.parseObject(h,ft.Asset,r);if(e)return Bt(Nt({},l),{children:[...a,{path:[...o,"asset"],value:e}]})}else{if(this.hooks.determineNodeType.call(c)===ft.Template&&Array.isArray(h)){const e=h.map((e=>{var t,n;const i=this.hooks.onCreateASTNode.call({type:ft.Template,depth:null!=(t=r.templateDepth)?t:0,data:e.data,template:e.value,dynamic:null!=(n=e.dynamic)&&n},e);if(i)return{path:[...o,e.output],value:i}})).filter((e=>!!e));return Bt(Nt({},l),{children:[...a,...e]})}if(h&&this.hooks.determineNodeType.call(h)===ft.Switch){const e=this.hooks.parseNode.call(h,ft.Value,r,ft.Switch);if(e)return Bt(Nt({},l),{children:[...a,{path:[...o,c],value:e}]})}else if(h&&Array.isArray(h)){const e=h.map((e=>this.parseObject(e,ft.Value,r))).filter((e=>!!e));if(e.length>0){const t=this.hooks.onCreateASTNode.call({type:ft.MultiNode,override:!0,values:e},h);if((null==t?void 0:t.type)===ft.MultiNode&&t.values.forEach((e=>{e.parent=t})),t)return Bt(Nt({},l),{children:[...a,{path:[...o,c],value:t}]})}}else{if(!h||"object"!==typeof h){return{children:a,value:(0,d.tP)(e.value,[...o,c],h)}}{const n=this.hooks.determineNodeType.call(h);if(n!==ft.Applicability){const t=i(e.value,h,[...o,c]);return{value:t.value,children:[...a,...t.children]}}{const e=this.hooks.parseNode.call(h,t,r,n);if(e)return Bt(Nt({},l),{children:[...a,{path:[...o,c],value:e}]})}}}}return e}),a)},{value:s,children:a}=i(void 0,e),l=void 0===s&&0===a.length?void 0:{type:t,value:s};if(void 0!==l&&a.length>0){const e=l;e.children=a,a.forEach((t=>{t.value.parent=e}))}return null!=(n=this.hooks.onCreateASTNode.call(l,e))?n:null}}var Dt=Object.defineProperty,Ut=Object.defineProperties,It=Object.getOwnPropertyDescriptors,$t=Object.getOwnPropertySymbols,Ft=Object.prototype.hasOwnProperty,Ht=Object.prototype.propertyIsEnumerable,zt=(e,t,r)=>t in e?Dt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;function Lt(e,t){if(!e||!t)return!0;const r=Array.from(t.values()),n=Array.from(e.values());return void 0!==r.find((e=>!!n.find((t=>t===e||t.contains(e)||e.contains(t)))))}function Wt(e){return t=((e,t)=>{for(var r in t||(t={}))Ft.call(t,r)&&zt(e,r,t[r]);if($t)for(var r of $t(t))Ht.call(t,r)&&zt(e,r,t[r]);return e})({},e),r={data:{model:e.model,formatValue:(t,r)=>e.formatValue?e.formatValue(t,r):r,format:(t,r)=>e.format?e.format(H(t)?t:e.parseBinding(t),r):r},evaluate:t=>e.evaluator.evaluate(t,e)},Ut(t,It(r));var t,r}var qt=Object.defineProperty,Gt=Object.defineProperties,Kt=Object.getOwnPropertyDescriptors,Qt=Object.getOwnPropertySymbols,Jt=Object.prototype.hasOwnProperty,Zt=Object.prototype.propertyIsEnumerable,Xt=(e,t,r)=>t in e?qt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,Yt=(e,t)=>{for(var r in t||(t={}))Jt.call(t,r)&&Xt(e,r,t[r]);if(Qt)for(var r of Qt(t))Zt.call(t,r)&&Xt(e,r,t[r]);return e},er=(e,t)=>Gt(e,Kt(t));class tr{constructor(e,t){this.hooks={skipResolve:new n.gg,beforeUpdate:new n.ni,afterUpdate:new n.ni,resolveOptions:new n.gg,beforeResolve:new n.gg,resolve:new n.gg,afterResolve:new n.gg,afterNodeUpdate:new n.ni},this.root=e,this.options=t,this.resolveCache=new Map,this.ASTMap=new Map,this.logger=t.logger,this.idCache=new Set}getSourceNode(e){return this.ASTMap.get(e)}update(e){this.hooks.beforeUpdate.call(e);const t=new Map;this.idCache.clear(),this.ASTMap.clear();const r=this.computeTree(this.root,void 0,e,t,Wt(this.options));return this.resolveCache=t,this.hooks.afterUpdate.call(r.value),r.value}getNodeID(e){var t;if(e)return e.type!==ft.Asset&&e.type!==ft.View&&e.type!==ft.Value||"object"!==typeof e.value||"string"!==typeof(null==(t=e.value)?void 0:t.id)?void 0:e.value.id}getPreviousResult(e){var t,r;if(!e)return;const n=0===this.resolveCache.size,o=this.getNodeID(e);if(o){if(this.idCache.has(o))return void(n&&(e.type===ft.Asset||e.type===ft.View?null==(t=this.logger)||t.error(`Cache conflict: Found Asset/View nodes that have conflicting ids: ${o}, may cause cache issues.`):e.type===ft.Value&&(null==(r=this.logger)||r.info(`Cache conflict: Found Value nodes that have conflicting ids: ${o}, may cause cache issues. To improve performance make value node IDs globally unique.`))));this.idCache.add(o)}return this.resolveCache.get(e)}computeTree(e,t,r,n,o){var i,s;const a=new ae(o.data.model);a.trackSubset("core");const l=(c=function(e,t){function r(r){const n=H(r)?r:t(r,{get:e.get,set:e.set});if(!n)throw new Error("Unable to parse binding");return n}return{get:(t,n)=>e.get(r(t),n),set:(t,n)=>e.set(t.map((([e,t])=>[r(e),t])),n)}}(a,this.options.parseBinding),{get:(e,t)=>c.get(e,Yt({context:{model:c}},t)),set:(e,t)=>c.set(e,Yt({context:{model:c}},t))});var c;const h=this.hooks.resolveOptions.call(er(Yt({},o),{data:er(Yt({},o.data),{model:l}),evaluate:e=>this.options.evaluator.evaluate(e,{model:l}),node:e}),e),p=this.getPreviousResult(e),f=null==p?void 0:p.dependencies,g=Lt(r,f);if(this.hooks.skipResolve.call(!g,e,h)&&p){const r=er(Yt({},p),{updated:!1});n.set(e,r);const o=(e,t)=>{var r;this.ASTMap.set(e,t),"children"in e&&(null==(r=e.children)||r.forEach((({value:e})=>{const{node:t}=this.getPreviousResult(e)||{};t&&(o(t,e),t.type===ft.MultiNode&&t.values.forEach((e=>{const{node:t}=this.getPreviousResult(e)||{};t&&o(t,e)})))})))},i=p.node;return o(i,e),this.hooks.afterNodeUpdate.call(e,t,r),r}const y=null!=(i=this.hooks.beforeResolve.call(e,h))?i:{type:ft.Empty};h.node=y,this.ASTMap.set(y,e);let w=this.hooks.resolve.call(void 0,y,h),m=!(0,v.J)(null==p?void 0:p.value,w);p&&!m&&(w=null==p?void 0:p.value);const b=new Set;a.trackSubset("children"),"children"in y&&(null==(s=y.children)||s.forEach((t=>{const o=this.computeTree(t.value,e,r,n,h);let{updated:i,value:s}=o;const{node:a,dependencies:l}=o;if(l.forEach((e=>b.add(e))),a.type===ft.MultiNode&&(s=[],a.values.forEach((t=>{const o=this.computeTree(t,e,r,n,h);void 0!==o.value&&null!==o.value&&s.push(o.value),o.dependencies.forEach((e=>b.add(e))),i=i||o.updated}))),s)if(a.type!==ft.MultiNode||a.override)w=(0,d.tP)(w,t.path,s);else{const e=(0,d.q5)(u()(w,t.path,[]),s);w=(0,d.tP)(w,t.path,e)}m=m||i}))),b.forEach((e=>a.addChildReadDep(e))),a.trackSubset("core"),p&&!m&&(w=null==p?void 0:p.value),w=this.hooks.afterResolve.call(w,y,er(Yt({},h),{getDependencies:e=>a.getDependencies(e)}));const S={node:y,updated:m,value:w,dependencies:new Set([...a.getDependencies(),...b])};return this.hooks.afterNodeUpdate.call(e,t,S),n.set(e,S),S}}class rr{constructor(e){this.hooks={resolveTemplateSubstitutions:new n.gg},this.options=e}parseTemplate(e,t,r){const{template:n,depth:o}=t,i=r.data.model.get(t.data);if(!i)return null;if(!Array.isArray(i))throw new Error(`Template using '${t.data}' but is not an array`);const s=[];i.forEach(((r,i)=>{const a=this.hooks.resolveTemplateSubstitutions.call([{expression:new RegExp(`_index${o||""}_`),value:String(i)}],{depth:o,data:r,index:i});let l=JSON.stringify(n);for(const{expression:e,value:t}of a){let r="g";"object"===typeof e&&(r=`${e.flags}${e.global?"":"g"}`),l=l.replace(new RegExp(e,r),t)}const c=e(JSON.parse(l),ft.Value,{templateDepth:t.depth+1});c&&s.push(c)}));const a={parent:t.parent,type:ft.MultiNode,values:s};return a.values.forEach((e=>{e.parent=a})),a}applyParser(e){e.hooks.onCreateASTNode.tap("template",(t=>t&&t.type===ft.Template&&!t.dynamic?this.parseTemplate(e.parseObject.bind(e),t,this.options):t)),e.hooks.determineNodeType.tap("template",(e=>{if("template"===e)return ft.Template})),e.hooks.parseNode.tap("template",((t,r,n,o)=>{var i,s;if(o===ft.Template){const r=e.createASTNode({type:ft.Template,depth:null!=(i=n.templateDepth)?i:0,data:t.data,template:t.value,dynamic:null!=(s=t.dynamic)&&s},t);if(r)return r}}))}applyResolverHooks(e){e.hooks.beforeResolve.tap("template",((e,t)=>e&&e.type===ft.Template&&e.dynamic?this.parseTemplate(t.parseNode,e,t):e))}apply(e){e.hooks.parser.tap("template",this.applyParser.bind(this)),e.hooks.resolver.tap("template",this.applyResolverHooks.bind(this))}}const nr=(e,t)=>r=>{const n=r.indexOf(e);if(-1===n)return!1;const o=r.indexOf(t);return-1!==o&&n<o},or=nr("{{","}}"),ir=nr("@[","]@");function sr(e,t){return function(e){return or(e)||ir(e)}(e)?vt(e,{model:t.data.model,evaluate:t.evaluate}):e}function ar(e,t,r){if(null===e||void 0===e||"object"!==typeof e&&"string"!==typeof e)return e;if("string"===typeof e)return sr(e,t);let n=e;return Object.keys(e).forEach((o=>{if(r.has(o))return;const i=e[o];let s=i;"object"===typeof i?s=ar(i,t,r):"string"===typeof i&&(s=sr(i,t)),s!==i&&(n=(0,d.t8)(n,o,s))})),n}const lr=e=>{var t,r,n;const o=e.parent;return o?"children"in o?null!=(n=null==(r=null==(t=o.children)?void 0:t.find((t=>t.value===e)))?void 0:r.path)?n:[]:o.type!==ft.MultiNode?[]:lr(o):[]};class cr{constructor(){this.propertiesToSkipCache=new Map}applyResolver(e){e.hooks.resolve.tap("string-resolver",((e,t,r)=>{var n,o,i,s,a,l,c,h,p,u;if(t.type===ft.Empty||t.type===ft.Unknown)return null;if(t.type===ft.Value||t.type===ft.Asset||t.type===ft.View){let e;t.type===ft.Asset||t.type===ft.View?(e=new Set(null!=(i=null==(o=null==(n=t.plugins)?void 0:n.stringResolver)?void 0:o.propertiesToSkip)?i:["exp"]),(null==(s=t.value)?void 0:s.id)&&this.propertiesToSkipCache.set(t.value.id,e)):e=(null==(a=t.parent)?void 0:a.type)===ft.MultiNode&&((null==(c=null==(l=t.parent)?void 0:l.parent)?void 0:c.type)===ft.Asset||(null==(p=null==(h=t.parent)?void 0:h.parent)?void 0:p.type)===ft.View)&&(null==(u=t.parent.parent.value)?void 0:u.id)&&this.propertiesToSkipCache.has(t.parent.parent.value.id)?this.propertiesToSkipCache.get(t.parent.parent.value.id):new Set(["exp"]);const d=lr(t);return d.length>0&&d.some((t=>e.has(t.toString())))?t.value:ar(t.value,r,e)}return e}))}apply(e){e.hooks.resolver.tap("string-resolver",this.applyResolver.bind(this))}}class hr{applyResolver(e){e.hooks.beforeResolve.tap("applicability",((e,t)=>{let r=e;if((null==e?void 0:e.type)===ft.Applicability){if(!t.evaluate(e.expression))return null;r=e.value}return r}))}applyParser(e){e.hooks.determineNodeType.tap("applicability",(e=>{if(Object.prototype.hasOwnProperty.call(e,"applicability"))return ft.Applicability})),e.hooks.parseNode.tap("applicability",((t,r,n,o)=>{if(o===ft.Applicability){const o=e.parseObject((0,d.CE)(t,"applicability"),r,n);if(null!==o){const r=e.createASTNode({type:ft.Applicability,expression:t.applicability,value:o},t);return(null==r?void 0:r.type)===ft.Applicability&&(r.value.parent=r),r}}}))}apply(e){e.hooks.resolver.tap("applicability",this.applyResolver.bind(this)),e.hooks.parser.tap("applicability",this.applyParser.bind(this))}}var pr=Object.getOwnPropertySymbols,ur=Object.prototype.hasOwnProperty,dr=Object.prototype.propertyIsEnumerable;class vr{constructor(e){this.options=e}resolveSwitch(e,t){for(const r of e.cases){if(t.evaluate(r.case))return r.value}return Rt}applyParser(e){e.hooks.onCreateASTNode.tap("switch",(e=>e&&e.type===ft.Switch&&!e.dynamic?this.resolveSwitch(e,this.options):e)),e.hooks.determineNodeType.tap("switch",(e=>{if(Object.prototype.hasOwnProperty.call(e,"dynamicSwitch")||Object.prototype.hasOwnProperty.call(e,"staticSwitch"))return ft.Switch})),e.hooks.parseNode.tap("switch",((t,r,n,o)=>{if(o===ft.Switch){const r="dynamicSwitch"in t,o="dynamicSwitch"in t?t.dynamicSwitch:t.staticSwitch,i=[];o.forEach((t=>{const r=t,{case:o}=r,s=((e,t)=>{var r={};for(var n in e)ur.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&pr)for(var n of pr(e))t.indexOf(n)<0&&dr.call(e,n)&&(r[n]=e[n]);return r})(r,["case"]),a=e.parseObject(s,ft.Value,n);a&&i.push({case:o,value:a})}));const s=e.hooks.onCreateASTNode.call({type:ft.Switch,dynamic:r,cases:i},t);return(null==s?void 0:s.type)===ft.Switch&&s.cases.forEach((e=>{e.value.parent=s})),(null==s?void 0:s.type)===ft.Empty?null:null!=s?s:null}}))}applyResolver(e){e.hooks.beforeResolve.tap("switch",((e,t)=>e&&e.type===ft.Switch&&e.dynamic?this.resolveSwitch(e,t):e))}apply(e){e.hooks.parser.tap("switch",this.applyParser.bind(this)),e.hooks.resolver.tap("switch",this.applyResolver.bind(this))}}var fr=Object.defineProperty,gr=Object.defineProperties,yr=Object.getOwnPropertyDescriptors,wr=Object.getOwnPropertySymbols,mr=Object.prototype.hasOwnProperty,br=Object.prototype.propertyIsEnumerable,Sr=(e,t,r)=>t in e?fr(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,kr=(e,t)=>{for(var r in t||(t={}))mr.call(t,r)&&Sr(e,r,t[r]);if(wr)for(var r of wr(t))br.call(t,r)&&Sr(e,r,t[r]);return e};class Er{constructor(e,t,r){this.allValidations=new Set,this.byBinding=new Map,this.logger=r,this.parse(e,t)}parse(e,t){var r;const n=e.validation;void 0!==n&&(Array.isArray(n)?n.forEach((e=>{var r;const n=kr({trigger:"navigation",severity:"error"},e);this.allValidations.add(n);const{ref:o}=e;if(o){const e=t(o);this.byBinding.has(e)?null==(r=this.byBinding.get(e))||r.push(n):this.byBinding.set(e,[n])}})):null==(r=this.logger)||r.warn(`Unable to register view validations for id: ${e.id}. 'validation' property must be an Array.`))}getValidationsForBinding(e){return this.byBinding.get(e)}}class Or{constructor(e,t){this.hooks={onUpdate:new n.ni,parser:new n.ni,resolver:new n.ni,templatePlugin:new n.ni},this.initialView=e,this.resolverOptions=t;const r=Wt(t);new vr(r).apply(this),(new hr).apply(this),(new cr).apply(this),this.templatePlugin=new rr(r),this.templatePlugin.apply(this)}update(e){var t,r,n;if(void 0===this.rootNode){this.validationProvider=new Er(this.initialView,this.resolverOptions.parseBinding,this.resolverOptions.logger),this.hooks.templatePlugin.call(this.templatePlugin);const e=new Mt;this.hooks.parser.call(e),this.rootNode=e.parseView(this.initialView),this.resolver=new tr(this.rootNode,(r=kr({},this.resolverOptions),n={parseNode:e.parseObject.bind(e)},gr(r,yr(n)))),this.hooks.resolver.call(this.resolver)}const o=null==(t=this.resolver)?void 0:t.update(e);return this.lastUpdate===o?this.lastUpdate:(this.lastUpdate=o,this.hooks.onUpdate.call(o),o)}getValidationsForBinding(e){var t;return null==(t=this.validationProvider)?void 0:t.getValidationsForBinding(e)}}var Pr=Object.defineProperty,jr=Object.getOwnPropertySymbols,Tr=Object.prototype.hasOwnProperty,Ar=Object.prototype.propertyIsEnumerable,xr=(e,t,r)=>t in e?Pr(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,Cr=(e,t,r)=>new Promise(((n,o)=>{var i=e=>{try{a(r.next(e))}catch(t){o(t)}},s=e=>{try{a(r.throw(e))}catch(t){o(t)}},a=e=>e.done?n(e.value):Promise.resolve(e.value).then(i,s);a((r=r.apply(e,t)).next())}));class Vr{constructor(e,t,r){this.hooks={beforeStart:new n.oI,onStart:new n.ni,onEnd:new n.ni,skipTransition:new n.oI,beforeTransition:new n.gg,resolveTransitionNode:new n.gg,transition:new n.ni},this.id=e,this.flow=t,this.log=null==r?void 0:r.logger,this.history=[],this.hooks.transition.tap("startPromise",((e,t)=>Cr(this,null,(function*(){const e=t.value;this.flowPromise&&"END"===e.state_type&&this.flowPromise.resolve(e)}))))}start(){return Cr(this,null,(function*(){var e;if(this.flowPromise)return null==(e=this.log)||e.warn("Already called start for flow"),this.flowPromise.promise;this.flow=this.hooks.beforeStart.call(this.flow)||this.flow,this.flow.onStart&&this.hooks.onStart.call(this.flow.onStart);const t=this.flow.startState;return t?(this.flowPromise=g()(),this.pushHistory(t),this.flowPromise.promise):Promise.reject(new Error("No 'startState' defined for flow"))}))}transition(e,t){var r,n,o,i,s,a;if("END"===(null==(r=this.currentState)?void 0:r.value.state_type))return void(null==(n=this.log)||n.warn(`Skipping transition using ${e}. Already at and END state`));if(void 0===this.currentState)throw new Error("Cannot transition when there's no current state");if(null==t?void 0:t.force)null==(o=this.log)||o.debug("Forced transition. Skipping validation checks");else{if(this.hooks.skipTransition.call(this.currentState))return void(null==(i=this.log)||i.debug(`Skipping transition from ${this.currentState} b/c hook told us to`))}const l=this.hooks.beforeTransition.call(this.currentState.value,e);if(!("transitions"in l))throw new Error(`No transitions defined for ${this.currentState.value}`);const{transitions:c}=l,h=c[e]||c["*"];if(void 0!==h)return null==(a=this.log)||a.debug(`Transitioning from ${this.currentState.name} to ${h} using ${e} `),this.pushHistory(h,t);null==(s=this.log)||s.warn(`No transition from ${this.currentState.name} using ${e} or *`)}pushHistory(e,t){var r;if(!Object.prototype.hasOwnProperty.call(this.flow,e))throw new Error(`No flow definition for: ${e} was found.`);let n=this.flow[e];if(!this.flow[e]||"object"!==typeof n||!("state_type"in n))return void(null==(r=this.log)||r.error(`Flow doesn't contain any states named: ${e}`));const o=this.currentState;n=this.hooks.resolveTransitionNode.call(n);const i={name:e,value:n};this.currentState=i,this.history.push(e),"END"===i.value.state_type&&this.flow.onEnd&&this.hooks.onEnd.call(this.flow.onEnd),this.hooks.transition.call(o,((e,t)=>{for(var r in t||(t={}))Tr.call(t,r)&&xr(e,r,t[r]);if(jr)for(var r of jr(t))Ar.call(t,r)&&xr(e,r,t[r]);return e})({},i))}}var _r=(e,t,r)=>new Promise(((n,o)=>{var i=e=>{try{a(r.next(e))}catch(t){o(t)}},s=e=>{try{a(r.throw(e))}catch(t){o(t)}},a=e=>e.done?n(e.value):Promise.resolve(e.value).then(i,s);a((r=r.apply(e,t)).next())}));class Nr{constructor(e,t){this.hooks={flow:new n.ni},this.navigation=e,this.navStack=[],this.log=null==t?void 0:t.logger,this.start=this.start.bind(this),this.run=this.run.bind(this),this.transition=this.transition.bind(this)}transition(e,t){if(void 0===this.current)throw new Error("Not currently in a flow. Cannot transition.");this.current.transition(e,t)}addNewFlow(e){return _r(this,null,(function*(){this.navStack.push(e),this.current=e,e.hooks.transition.tap("flow-controller",((t,r)=>_r(this,null,(function*(){var t,n;if("FLOW"===r.value.state_type){null==(t=this.log)||t.debug(`Got FLOW state. Loading flow ${r.value.ref}`);const o=yield this.run(r.value.ref);null==(n=this.log)||n.debug(`Flow ended. Using outcome: ${o.outcome}`),e.transition(o.outcome)}})))),this.hooks.flow.call(e)}))}run(e){return _r(this,null,(function*(){var t;if(!Object.prototype.hasOwnProperty.call(this.navigation,e))return Promise.reject(new Error(`No flow defined for: ${e}`));const r=this.navigation[e];if(null===r||"object"!==typeof r)return Promise.reject(new Error(`Flow: ${e} needs to be an object`));null==(t=this.log)||t.debug(`Starting flow: ${e}`);const n=new Vr(e,r,{logger:this.log});this.addNewFlow(n);const o=yield n.start();if(this.navStack.pop(),this.navStack.length>0){const e=0;this.current=this.navStack[e]}return o}))}start(){return _r(this,null,(function*(){return this.navigation.BEGIN?this.run(this.navigation.BEGIN):Promise.reject(new Error("Must supply a BEGIN state"))}))}}const Br=/%([a-zA-Z]+)/g;var Rr=Object.defineProperty,Mr=Object.defineProperties,Dr=Object.getOwnPropertyDescriptors,Ur=Object.getOwnPropertySymbols,Ir=Object.prototype.hasOwnProperty,$r=Object.prototype.propertyIsEnumerable,Fr=(e,t,r)=>t in e?Rr(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,Hr=(e,t)=>{for(var r in t||(t={}))Ir.call(t,r)&&Fr(e,r,t[r]);if(Ur)for(var r of Ur(t))$r.call(t,r)&&Fr(e,r,t[r]);return e},zr=(e,t)=>Mr(e,Dr(t));const Lr="validation-binding-tracker";class Wr{constructor(e){this.trackedBindings=new Set,this.options=e}getBindings(){return this.trackedBindings}applyResolver(e){this.trackedBindings.clear();const t=new Map,r=new Map,n=new Set;let o;const i=new Map;let s=new Map,a=new Map;const l=new Map;e.hooks.beforeUpdate.tap(Lr,(e=>{o=e})),e.hooks.skipResolve.tap(Lr,((e,t)=>{const r=s.get(t);if(!e||!o||!r)return e;return 0===new Set([...o].filter((e=>r.has(e)))).size})),e.hooks.resolveOptions.tap(Lr,((e,o)=>{if(void 0===e.validation)return e;t.delete(o);const i=e=>{var i,s,a,l;const c=H(e)?e:this.options.parseBinding(e);t.has(o)?null==(i=t.get(o))||i.add(c):t.set(o,new Set([c]));let{parent:h}=o;for(;h;){if(r.has(h)){null==(s=r.get(h))||s.add(o);break}h=h.parent}n.has(c)||(n.add(c),null==(l=null==(a=this.options.callbacks)?void 0:a.onAdd)||l.call(a,c))};return zr(Hr({},e),{validation:zr(Hr({},e.validation),{get:(t,r)=>{var n;(null==r?void 0:r.track)&&i(t);const o=null==(n=e.validation)?void 0:n._getValidationForBinding(t);if(void 0===(null==o?void 0:o.displayTarget)||"field"===(null==o?void 0:o.displayTarget))return o},getChildren:t=>{var r;const n=new Array;return null==(r=s.get(o))||r.forEach((r=>{var o;const i=null==(o=e.validation)?void 0:o._getValidationForBinding(r);i&&t===i.displayTarget&&n.push(i)})),n},getValidationsForSection:()=>{var t;const r=new Array;return null==(t=l.get(o))||t.forEach((t=>{var n;const o=null==(n=e.validation)?void 0:n._getValidationForBinding(t);o&&"section"===o.displayTarget&&r.push(o)})),r},register:e=>{"section"===(null==e?void 0:e.type)&&(r.has(o)||r.set(o,new Set))},track:i})})})),e.hooks.afterNodeUpdate.tap(Lr,((n,o,c)=>{var h,p,u;if(o&&function(e,t){var r;i.has(t)?null==(r=i.get(t))||r.add(e):i.set(t,new Set([e]))}(n,o),c.updated){const e=new Set(t.get(n));null==(h=i.get(n))||h.forEach((t=>{var r;null==(r=a.get(t))||r.forEach((t=>e.add(t)))})),a.set(n,e)}else a.set(n,null!=(p=s.get(n))?p:new Set);n===e.root&&(this.trackedBindings=null!=(u=a.get(n))?u:new Set,s=a,l.clear(),r.forEach(((e,r)=>{const n=new Set;e.forEach((e=>{var r;null==(r=t.get(e))||r.forEach(n.add,n)})),l.set(r,n)})),i.clear(),t.clear(),r.clear(),a=new Map)}))}apply(e){e.hooks.resolver.tap(Lr,this.applyResolver.bind(this))}}var qr=Object.defineProperty,Gr=Object.defineProperties,Kr=Object.getOwnPropertyDescriptors,Qr=Object.getOwnPropertySymbols,Jr=Object.prototype.hasOwnProperty,Zr=Object.prototype.propertyIsEnumerable,Xr=(e,t,r)=>t in e?qr(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,Yr=(e,t)=>{for(var r in t||(t={}))Jr.call(t,r)&&Xr(e,r,t[r]);if(Qr)for(var r of Qr(t))Zr.call(t,r)&&Xr(e,r,t[r]);return e},en=(e,t)=>Gr(e,Kr(t));class tn{constructor(e,t,r,n){this.applicableValidations=[],this.validationsByState={load:[],change:[],navigation:[]},this.onDismiss=t,e.forEach((e=>{const{trigger:t}=e;var n;this.validationsByState[t]?this.validationsByState[t].push({value:n=e,type:n.severity,state:"none"}):null==r||r.warn(`Unknown validation trigger: ${t}`)})),this.weakBindings=null!=n?n:new Set}get(){const e=this.applicableValidations.find((e=>{const t="navigation"!==this.currentPhase||e.value.blocking;return"active"===e.state&&!1!==t}));if("active"===(null==e?void 0:e.state))return e.response}runApplicableValidations(e,t){this.applicableValidations=this.applicableValidations.map((r=>{var n,o,i;if("dismissed"===r.state)return r;const s=null!=(n=r.value.blocking)?n:"warning"===r.value.severity?"once":"error"===r.value.severity&&!0,a=t&&"once"===s;if("navigation"===this.currentPhase&&"active"===r.state&&a){if("warning"===r.value.severity){const e=r;return e.dismissable&&e.response.dismiss?e.response.dismiss():e.dismissable=!0,r}if("error"===r.value.severity){return r.state="none",r}}const l=e(r.value),c={type:r.type,value:r.value,state:l?"active":"none",dismissable:"warning"===r.value.severity&&"navigation"===this.currentPhase,response:l?en(Yr({},r.value),{message:null!=(o=l.message)?o:"Something is broken",severity:r.value.severity,displayTarget:null!=(i=r.value.displayTarget)?i:"field"}):void 0};return"active"===c.state&&"warning"===r.value.severity&&(c.response.dismiss=()=>{var e;c.state="dismissed",null==(e=this.onDismiss)||e.call(this)}),c}))}update(e,t,r){"load"===e&&void 0!==this.currentPhase||("navigation"!==this.currentPhase&&e!==this.currentPhase?("load"===e?(this.currentPhase="load",this.applicableValidations=[...this.validationsByState.load]):"change"===e&&"load"===this.currentPhase?(this.currentPhase="change",this.applicableValidations=[...this.applicableValidations,...this.validationsByState.change]):"navigation"!==e||"load"!==this.currentPhase&&"change"!==this.currentPhase||(this.applicableValidations=[...this.applicableValidations,..."load"===this.currentPhase?this.validationsByState.change:[],...this.validationsByState.navigation],this.currentPhase="navigation"),this.runApplicableValidations(r,t)):this.runApplicableValidations(r,t))}}class rn{constructor(e,t){this.hooks={createValidatorRegistry:new n.ni,onAddValidation:new n.gg,onRemoveValidation:new n.gg},this.validations=new Map,this.weakBindingTracker=new Set,this.lastActiveBindings=new Set,this.schema=e,this.options=t,this.providers=[e]}setOptions(e){this.options=e}getDataMiddleware(){return[new Ot((e=>{var t;if(!this.options)return;this.updateValidationsForBinding(e,"change",this.options);const r=this.getValidationForBinding(e);if("error"===(null==(t=null==r?void 0:r.get())?void 0:t.severity))return r.get();const n=new Set;return this.validations.forEach(((t,r)=>{var o;Lt(new Set([e]),t.weakBindings)&&"error"===(null==(o=null==t?void 0:t.get())?void 0:o.severity)&&(null==t||t.weakBindings.forEach((e=>{e===r?n.add({binding:e,isStrong:!0}):n.add({binding:e,isStrong:!1})})))})),n.size>0?n:void 0}),{logger:new Xe((()=>{var e;return null==(e=this.options)?void 0:e.logger}))})]}onView(e){if(this.validations.clear(),!this.options)return;const t=new Wr(en(Yr({},this.options),{callbacks:{onAdd:t=>{if(!this.options)return;const r=this.options.model.get(t);r!==this.options.model.get(t,{ignoreDefaultValue:!0})&&this.options.model.set([[t,r]],{silent:!0}),this.updateValidationsForBinding(t,"load",this.options,(()=>{e.update(new Set([t]))}))}}}));this.tracker=t,this.providers=[this.schema,e],t.apply(e)}updateValidationsForBinding(e,t,r,n){var o;if("load"===t){const t=this.providers.reduce(((t,r)=>{var n,o;return[...t,...null!=(o=null==(n=r.getValidationsForBinding)?void 0:n.call(r,e))?o:[]]}),[]);if(0===t.length)return;this.validations.set(e,new tn(t,n,null==(o=this.options)?void 0:o.logger))}const i=this.validations.get(e);null==i||i.update(t,!0,(t=>{const n=this.validationRunner(t,r,e);if(this.weakBindingTracker.size>0){const t=this.validations.get(e);this.weakBindingTracker.forEach((e=>t.weakBindings.add(e)))}return n?{message:n.message}:void 0})),"load"!==t&&this.validations.forEach(((n,o)=>{o!==e&&Lt(new Set([e]),n.weakBindings)&&n.update(t,!0,(e=>{const t=this.validationRunner(e,r,o);return t?{message:t.message}:void 0}))}))}validationRunner(e,t,r){const n=this.getValidator(e.type),o=new Set,i={get:(e,n={includeInvalid:!0})=>(o.add(H(e)?r:t.parseBinding(e)),t.model.get(e,n)),set:t.model.set},s=null==n?void 0:n(en(Yr({},t),{evaluate:(e,r={model:i})=>t.evaluate(e,r),model:i,validation:e}),t.model.get(r,{includeInvalid:!0,formatted:"formatted"===e.dataTarget}),e);if(this.weakBindingTracker=o,s){let{message:r}=s;const{parameters:n}=s;return e.message&&(r=vt(e.message,{model:i,evaluate:t.evaluate}),n&&(r=function(e,t){return e.slice().replace(Br,(e=>t[e.slice(1)]||e))}(r,n))),{message:r}}}updateValidationsForView(e){const{activeBindings:t}=this,r="navigation"!==e||this.setCompare(this.lastActiveBindings,t);this.getBindings().forEach((t=>{var n;null==(n=this.validations.get(t))||n.update(e,r,(e=>{if(this.options)return this.validationRunner(e,this.options,t)}))})),"navigation"===e&&(this.lastActiveBindings=t)}setCompare(e,t){if(e.size!==t.size)return!1;for(const r of e)if(!t.has(r))return!1;return!0}get activeBindings(){return new Set(Array.from(this.getBindings()).filter((e=>{var t;return void 0!==(null==(t=this.validations.get(e))?void 0:t.get())})))}getValidator(e){if(this.validatorRegistry)return this.validatorRegistry.get(e);const t=new Pt;return this.hooks.createValidatorRegistry.call(t),this.validatorRegistry=t,t.get(e)}getBindings(){var e,t;return null!=(t=null==(e=this.tracker)?void 0:e.getBindings())?t:new Set}validateView(e="navigation"){this.updateValidationsForView(e);const t=new Map;return this.getBindings().forEach((e=>{var r,n;const o=null==(r=this.getValidationForBinding(e))?void 0:r.get();o&&(null==(n=this.options)||n.logger.debug(`Validation on binding: ${e.asString()} is preventing navigation. ${JSON.stringify(o)}`),t.set(e,o))})),{canTransition:0===t.size,validations:t.size?t:void 0}}getValidationForBinding(e){return this.validations.get(e)}forView(e){return{_getValidationForBinding:t=>{var r;return null==(r=this.getValidationForBinding(H(t)?t:e(t)))?void 0:r.get()},getAll:()=>{const e=this.getBindings();if(0===e.size)return;const t=new Map;return e.forEach((e=>{var r;const n=null==(r=this.getValidationForBinding(e))?void 0:r.get();n&&t.set(e,n)})),0===t.size?void 0:t},get(){throw new Error("Error Access be provided by the view plugin")},getChildren(){throw new Error("Error rollup should be provided by the view plugin")},getValidationsForSection(){throw new Error("Error rollup should be provided by the view plugin")},track:()=>{throw new Error("Tracking should be provided by the view plugin")},register:()=>{throw new Error("Section funcationality hould be provided by the view plugin")},type:t=>this.schema.getType(H(t)?t:e(t))}}}class nn{constructor(e){this.updateCallback=e,this.state=new Map}removeKey(e){this.state.delete(e)}reset(){this.state.clear()}useSharedState(e){return t=>(this.state.has(e)||this.state.set(e,t),[this.state.get(e),t=>{var r;const n=this.state.get(e);this.state.set(e,t),n!==t&&(null==(r=this.updateCallback)||r.call(this))}])}getLocalStateFunction(e,t){return r=>{this.state.has(e)||this.state.set(e,[]),this.state.has(t)||this.state.set(t,0);const n=this.state.get(e),o=this.state.get(t);this.state.set(t,o+1),n.length<=o&&n.push(r);return[n[o],e=>{var t;const r=n[o];n[o]=e,r!==e&&(null==(t=this.updateCallback)||t.call(this))}]}}}function on(e,t){return e===t||!!e.parent&&on(e.parent,t)}class sn{constructor(e){this.registry=e,this.stateStore=new Map,this.beforeResolveSymbol=Symbol("before resolve"),this.resolveSymbol=Symbol("resolve"),this.beforeResolveCountSymbol=Symbol("before resolve count"),this.resolveCountSymbol=Symbol("resolve count")}apply(e){e.hooks.view.tap("asset-transform",(e=>{this.stateStore.clear(),e.hooks.resolver.tap("asset-transform",(t=>{let r;const n=(t,n)=>{let o;const i=n===this.resolveSymbol?this.resolveCountSymbol:this.beforeResolveCountSymbol,s=this.stateStore.get(t);return s?(o=s,o.removeKey(i)):(o=new nn((()=>{(t=>{r=t,e.update(new Set)})(t)})),this.stateStore.set(t,o)),{useSharedState:e=>o.useSharedState(e),useLocalState:e=>o.getLocalStateFunction(n,i)(e)}};t.hooks.beforeResolve.tap("asset-transform",((e,t)=>{if(e&&("asset"===e.type||"view"===e.type)){const r=this.registry.get(e.value);if(null==r?void 0:r.beforeResolve){const o=n(e,this.beforeResolveSymbol);return r.beforeResolve(e,t,o)}}return e})),t.hooks.afterUpdate.tap("asset-transform",(()=>{r=void 0})),t.hooks.skipResolve.tap("asset-transform",((e,t)=>{if(!e||!r)return e;const n=on(r,t),o=on(t,r);return!n&&!o})),t.hooks.afterResolve.tap("asset-transform",((e,r,o)=>{if(r.type!==ft.Asset&&r.type!==ft.View)return e;const i=t.getSourceNode(r);if(!i)return e;const s=this.registry.get(e);if(null==s?void 0:s.resolve){const t=n(i,this.resolveSymbol);return null==s?void 0:s.resolve(e,o,t)}return e}))}))}))}}var an=Object.defineProperty,ln=Object.defineProperties,cn=Object.getOwnPropertyDescriptors,hn=Object.getOwnPropertySymbols,pn=Object.prototype.hasOwnProperty,un=Object.prototype.propertyIsEnumerable,dn=(e,t,r)=>t in e?an(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;class vn{constructor(e,t){this.hooks={resolveView:new n.gg,view:new n.ni},this.transformRegistry=new m.B,this.optimizeUpdates=!0,this.viewOptions=t,this.viewMap=e.reduce(((e,t)=>{return r=((e,t)=>{for(var r in t||(t={}))pn.call(t,r)&&dn(e,r,t[r]);if(hn)for(var r of hn(t))un.call(t,r)&&dn(e,r,t[r]);return e})({},e),n={[t.id]:t},ln(r,cn(n));var r,n}),{}),new sn(this.transformRegistry).apply(this),t.flowController.hooks.flow.tap("viewController",(e=>{e.hooks.transition.tap("viewController",((e,t)=>{"VIEW"===t.value.state_type?this.onView(t.value):this.currentView=void 0}))})),t.model.hooks.onUpdate.tap("viewController",(e=>{this.currentView&&(this.optimizeUpdates?this.queueUpdate(new Set(e.map((e=>e.binding)))):this.currentView.update())}))}queueUpdate(e){var t;(null==(t=this.pendingUpdate)?void 0:t.changedBindings)?this.pendingUpdate.changedBindings=new Set([...this.pendingUpdate.changedBindings,...e]):(this.pendingUpdate={changedBindings:e},w()((()=>{var e,t;const r=null==(e=this.pendingUpdate)?void 0:e.changedBindings;this.pendingUpdate=void 0,null==(t=this.currentView)||t.update(r)})))}getViewForRef(e){if(this.viewMap[e])return this.viewMap[e];const t=Object.keys(this.viewMap).find((t=>e===ut(t,{model:this.viewOptions.model,evaluate:this.viewOptions.evaluator.evaluate})));return t&&this.viewMap[t]?this.viewMap[t]:void 0}onView(e){const t=e.ref,r=this.hooks.resolveView.call(this.getViewForRef(t),t,e);if(!r)throw new Error(`No view with id ${t}`);const n=new Or(r,this.viewOptions);this.currentView=n,this.hooks.view.call(n),n.update()}}class fn{constructor(e,t){this.hooks={resolve:new n.gg,resolveDataStages:new n.gg,resolveDefaultValue:new n.oI,onDelete:new n.ni,onSet:new n.ni,onGet:new n.ni,onUpdate:new n.ni,format:new n.gg,deformat:new n.gg,serialize:new n.gg},this.logger=t.logger;const r=t.middleware||[];this.baseMiddleware=[new de(e),...r],this.trash=new Set,this.pathResolver=t.pathResolver}getModel(){if(!this.model){const e=this.hooks.resolveDataStages.call(this.baseMiddleware),t=new ue;t.setMiddleware(e),this.model=t}return this.model}resolveDataValue(e,t,r){return r?this.hooks.deformat.call(t,e):t}set(e,t){let r=[];r=Array.isArray(e)?e.map((([e,r])=>{const n=this.pathResolver.parse(e);return[n,this.resolveDataValue(n,r,Boolean(null==t?void 0:t.formatted))]})):Object.keys(e).map((r=>{const n=this.pathResolver.parse(r),o=e[r];return[n,this.resolveDataValue(n,o,Boolean(null==t?void 0:t.formatted))]}));const n=r.reduce(((e,[t,r])=>{var n;const o=this.get(t,{includeInvalid:!0});return(0,v.J)(o,r)||e.push({binding:t,newValue:r,oldValue:o}),null==(n=this.logger)||n.debug(`Setting path: ${t.asString()} from: ${o} to: ${r}`),e}),[]),o=this.getModel().set(r,t),i=new Set(n.map((e=>e.binding)));return o.forEach((e=>{var t;i.has(e.binding)||!0!==e.force&&(0,v.J)(e.oldValue,e.newValue)||(null==(t=this.logger)||t.debug(`Path: ${e.binding.asString()} was changed from: ${e.oldValue} to: ${e.newValue}`),n.push(e))})),this.hooks.onSet.call(r),n.length>0&&this.hooks.onUpdate.call(n,t),o}resolve(e){return Array.isArray(e)||"string"===typeof e?this.pathResolver.parse(e):e}get(e,t){const r=e instanceof z?e:this.resolve(e);let n=this.getModel().get(r,t);if(void 0===n&&!(null==t?void 0:t.ignoreDefaultValue)){const e=this.hooks.resolveDefaultValue.call(r);e!==n&&(n=e)}return(null==t?void 0:t.formatted)&&(n=this.hooks.format.call(n,r)),this.hooks.onGet.call(e,n),n}delete(e){if(void 0===e||null===e)throw new Error("Invalid arguments: delete expects a data path (string)");const t=this.resolve(e);this.hooks.onDelete.call(t),this.deleteData(t)}getTrash(){return this.trash}addToTrash(e){this.trash.add(e)}deleteData(e){const t=e.parent(),r=t.asString(),n=e.key(),o=Object.prototype.hasOwnProperty.call(this.get(t),n);if(void 0!==n){const e=t?this.get(t):void 0;r&&Array.isArray(e)?e.length>n&&this.set([[t,(0,d.D3)(e,n)]]):r&&e[n]?this.set([[t,(0,d.CE)(e,n)]]):r||this.getModel().reset((0,d.CE)(this.get(""),n))}o&&!this.get(e)&&this.addToTrash(e)}serialize(){return this.hooks.serialize.call(this.get(""))}}var gn=Object.defineProperty,yn=Object.getOwnPropertySymbols,wn=Object.prototype.hasOwnProperty,mn=Object.prototype.propertyIsEnumerable,bn=(e,t,r)=>t in e?gn(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,Sn=(e,t)=>{for(var r in t||(t={}))wn.call(t,r)&&bn(e,r,t[r]);if(yn)for(var r of yn(t))mn.call(t,r)&&bn(e,r,t[r]);return e};function kn(e,t=[],r="."){return Object.keys(e).reduce(((n,o)=>Sn(Sn({},n),"[object Object]"===Object.prototype.toString.call(e[o])?kn(e[o],t.concat([o])):{[t.concat([o]).join(r)]:e[o]})),{})}function En(e){const t=kn(e),r=[];return Object.keys(t).forEach((e=>{r.push([new z(e),t[e]])})),r}class On{constructor(){this.store=new Map,this.tempStore=new Map}addConstants(e,t){var r;this.store.has(t)?null==(r=this.store.get(t))||r.set(En(e)):this.store.set(t,new de(e))}getConstants(e,t,r){var n,o,i,s;const a=new z(e);return null!=(s=null!=(i=null==(n=this.tempStore.get(t))?void 0:n.get(a))?i:null==(o=this.store.get(t))?void 0:o.get(a))?s:r}setTemporaryValues(e,t){var r;this.tempStore.has(t)?null==(r=this.tempStore.get(t))||r.set(En(e)):this.tempStore.set(t,new de(e))}clearTemporaryValues(){this.tempStore.forEach((e=>{e.reset()}))}}class Pn{constructor(){this.name="flow-exp-plugin"}apply(e){let t;const r=e=>{e&&("object"===typeof e&&"exp"in e?null==t||t.evaluate(e.exp):null==t||t.evaluate(e))};e.hooks.expressionEvaluator.tap(this.name,(e=>{t=e})),e.hooks.flowController.tap(this.name,(e=>{e.hooks.flow.tap(this.name,(e=>{e.hooks.onStart.tap(this.name,(e=>r(e))),e.hooks.onEnd.tap(this.name,(e=>r(e))),e.hooks.resolveTransitionNode.intercept({call:e=>{(null==e?void 0:e.onStart)&&r(e.onStart)}})}))}))}}class jn{constructor(){this.name="flow-exp-plugin"}apply(e){let t;e.hooks.schema.tap(this.name,(e=>{var r;r=e,t=(e,t,n)=>{var o,i;return null!=(i=null==(o=r.getFormatterForType({type:n}))?void 0:o.format(t))?i:t}})),e.hooks.expressionEvaluator.tap(this.name,(r=>{t&&r.addExpressionFunction("format",t),r.addExpressionFunction("log",((t,...r)=>{e.logger.info(...r)})),r.addExpressionFunction("debug",((t,...r)=>{e.logger.debug(...r)})),r.addExpressionFunction("eval",((e,...t)=>e.evaluate(...t)))}))}}const Tn={ref:Symbol("not-started"),status:"not-started"};var An=Object.defineProperty,xn=Object.defineProperties,Cn=Object.getOwnPropertyDescriptors,Vn=Object.getOwnPropertySymbols,_n=Object.prototype.hasOwnProperty,Nn=Object.prototype.propertyIsEnumerable,Bn=(e,t,r)=>t in e?An(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,Rn=(e,t)=>{for(var r in t||(t={}))_n.call(t,r)&&Bn(e,r,t[r]);if(Vn)for(var r of Vn(t))Nn.call(t,r)&&Bn(e,r,t[r]);return e};const Mn=class{constructor(e){var t;this.logger=new Ze,this.constantsController=new On,this.state=Tn,this.hooks={flowController:new n.ni,viewController:new n.ni,view:new n.ni,expressionEvaluator:new n.ni,dataController:new n.ni,schema:new n.ni,validationController:new n.ni,bindingParser:new n.ni,state:new n.ni,onStart:new n.ni,onEnd:new n.ni,resolveFlowContent:new n.gg},(null==e?void 0:e.logger)&&this.logger.addHandler(e.logger),this.config=e||{},this.config.plugins=[new jn,...this.config.plugins||[],new Pn],null==(t=this.config.plugins)||t.forEach((e=>{e.apply(this)}))}getPlugins(){var e;return null!=(e=this.config.plugins)?e:[]}findPlugin(e){var t;return null==(t=this.config.plugins)?void 0:t.find((t=>t.symbol===e))}applyTo(e,t){const r=this.findPlugin(e);r&&t(r)}registerPlugin(e){var t;e.apply(this),null==(t=this.config.plugins)||t.push(e)}getVersion(){return Mn.info.version}getCommit(){return Mn.info.commit}getState(){return this.state}setState(e){this.state=e,this.hooks.state.call(e)}setupFlow(e){const t=this.hooks.resolveFlowContent.call(e),r=new Nr(t.navigation,{logger:this.logger});let n,o;this.hooks.onStart.call(t),this.hooks.flowController.call(r);const i=new ie({get:e=>o.get(e),set:e=>o.set(e),evaluate:e=>n.evaluate(e)});this.hooks.bindingParser.call(i);const s=i.parse,a=g()(),l=new lt(t.schema);this.hooks.schema.call(l);const c=new rn(l);let h;function p(e){return vt(e,{model:o,evaluate:n.evaluate})}var u,v;return this.hooks.validationController.call(c),o=new fn(t.data,{pathResolver:i,middleware:c.getDataMiddleware(),logger:this.logger}),o.hooks.format.tap("player",((e,t)=>{const r=l.getFormatter(t);return r?r.format(e):e})),o.hooks.deformat.tap("player",((e,t)=>{const r=l.getFormatter(t);return r?r.deformat(e):e})),o.hooks.resolveDefaultValue.tap("player",(e=>{var t;return null==(t=l.getApparentType(e))?void 0:t.default})),n=new Ke({model:o,logger:this.logger}),this.hooks.expressionEvaluator.call(n),n.hooks.onError.tap("player",(e=>(a.reject(e),!0))),r.hooks.flow.tap("player",(e=>{e.hooks.beforeTransition.tap("player",((e,t)=>{const r=e.transitions[t]?t:"*";return e.onEnd&&e.transitions[r]&&("object"===typeof e.onEnd&&"exp"in e.onEnd?null==n||n.evaluate(e.onEnd.exp):null==n||n.evaluate(e.onEnd)),"transitions"in e&&e.transitions[r]?(0,d.tP)(e,["transitions",r],p(e.transitions[r])):e})),e.hooks.skipTransition.tap("validation",(e=>{var t;if("VIEW"===(null==e?void 0:e.value.state_type)){const{canTransition:e,validations:r}=c.validateView("navigation");if(!e&&r){const e=new Set(r.keys());return null==(t=null==h?void 0:h.currentView)||t.update(e),!0}}})),e.hooks.resolveTransitionNode.tap("player",(e=>{let t=e;return"ref"in e&&(t=(0,d.tP)(e,["ref"],p(e.ref))),"param"in e&&(t=(0,d.tP)(e,["param"],p(e.param))),t})),e.hooks.transition.tap("player",((e,t)=>{if("ACTION"===t.value.state_type){const{exp:e}=t.value;w()((()=>{try{null==r||r.transition(String(null==n?void 0:n.evaluate(e)))}catch(t){const e=this.getState();t instanceof Error&&"in-progress"===e.status&&e.fail(t)}}))}n.reset()}))})),this.hooks.dataController.call(o),c.setOptions({parseBinding:s,model:o,logger:this.logger,evaluate:n.evaluate,constants:this.constantsController}),h=new vn(t.views||[],{evaluator:n,parseBinding:s,transition:r.transition,model:o,logger:this.logger,flowController:r,schema:l,format:(e,t)=>{const r=l.getFormatter(e);return(null==r?void 0:r.format)?r.format(t):t},formatValue:(e,t)=>{const r=l.getFormatterForType(e);return(null==r?void 0:r.format)?r.format(t):t},validation:(u=Rn({},c.forView(s)),v={type:e=>l.getType(s(e))},xn(u,Cn(v)))}),h.hooks.view.tap("player",(e=>{c.onView(e),this.hooks.view.call(e)})),this.hooks.viewController.call(h),{start:()=>{r.start().then((e=>({endState:p(e),data:o.serialize()}))).then(a.resolve).catch((e=>{throw this.logger.error(`Something went wrong: ${e.message}`),e})).catch(a.reject).finally((()=>this.hooks.onEnd.call()))},state:{status:"in-progress",flowResult:a.promise,controllers:{data:o,view:h,flow:r,schema:l,expression:n,binding:i,validation:c},fail:a.reject,flow:t,logger:this.logger}}}start(e){return t=this,r=null,n=function*(){var t;const r=Symbol(null!=(t=null==e?void 0:e.id)?t:"payload"),n=e=>this.state.ref!==r?(this.logger.warn("Received update for a flow that's not the current one"),e):(this.setState(e),e);this.setState({status:"not-started",ref:r});try{const{state:t,start:o}=this.setupFlow(e);this.setState(Rn({ref:r},t)),o();const i={ref:r,status:"completed",flow:t.flow,dataModel:t.controllers.data.getModel()};return n(Rn(Rn({},yield t.flowResult),i))}catch(o){throw n({status:"error",ref:r,flow:e,error:o}),o}},new Promise(((e,o)=>{var i=e=>{try{a(n.next(e))}catch(t){o(t)}},s=e=>{try{a(n.throw(e))}catch(t){o(t)}},a=t=>t.done?e(t.value):Promise.resolve(t.value).then(i,s);a((n=n.apply(t,r)).next())}));var t,r,n}};let Dn=Mn;Dn.info={version:"__VERSION__",commit:"__GIT_COMMIT__"}}}]);